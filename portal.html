<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פורטל לקוחות משודרג - PsychoFlash Productions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-dark: #003f5c;
            --primary-purple: #7a5195;
            --secondary-blue: #005f73;
            --text-dark: #212529;
            --bg-light: #f1f5f9;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-scream: #ff1111;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll, manage scrolling inside containers */
        }
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
        }
        #main-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .hidden { display: none; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .main-content { grid-column: span 12 / span 12; }
        @media (min-width: 1024px) {
            .main-content { grid-column: span 8 / span 8; }
            .sidebar { grid-column: span 4 / span 4; }
        }
        .card { background-color: var(--bg-white); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        
        .calendar-day { 
            position: relative; border: 1px solid var(--border-color); background-color: #fafafa; aspect-ratio: 1 / 1; 
            padding: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; overflow: hidden; 
            background-image: none;
        }
        .calendar-day:not(.other-month):hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 15px rgba(0,0,0,0.2);}
        .calendar-day.other-month { background: transparent; border-color: transparent; cursor: default; }
        .calendar-day .day-number { font-size: 0.9rem; z-index: 2; position: relative; color: var(--text-dark); }
        .calendar-day .price { font-size: 1rem; font-weight: 800; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); z-index: 2; }
        .day-events { display: flex; justify-content: center; align-items: center; gap: 4px; position: absolute; top: 35px; left: 0; right: 0; }
        .event-chip { width: 9px; height: 9px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); }

        .graph-footer-container {
            flex-shrink: 0; /* Prevent the footer from shrinking */
            z-index: 60;
            border-top: 2px solid var(--border-color);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            transition: height 0.35s ease-in-out;
            height: 250px; 
            padding: 0 1.5rem;
            cursor: pointer;
        }
        .graph-footer-container.minimized {
            height: 60px;
            cursor: pointer;
        }

        #histogram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            padding-bottom: 0.5rem;
            position: relative;
        }
        
        #graph-container {
            height: calc(100% - 50px);
            position: relative;
        }
        
        .graph-footer-container.minimized #histogram-header {
            height: 100%;
            cursor: pointer;
            border-radius: 16px 16px 0 0;
            overflow: hidden;
        }
        .graph-footer-container.minimized #histogram-title {
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            width: 100%;
            text-align: center;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            padding: 0;
            border: none;
            z-index: 10;
        }
        .graph-footer-container.minimized #toggle-graph-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            z-index: 15;
        }

        .graph-footer-container.minimized #graph-container {
            display: none;
        }

        #expanded-graph {
            width: 100%;
            height: 100%;
        }
        #histogram-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .price-path {
            stroke-width: 2.5;
            stroke: var(--warning);
            fill: url(#price-gradient);
            stroke-linejoin: round;
            stroke-linecap: round;
        }
        .monthly-hours-bar {
            fill: var(--primary-purple);
            opacity: 0.3;
        }
        .axis-line { stroke: var(--border-color); stroke-width: 1; }
        .axis-label { font-size: 10px; fill: #64748b; }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 1.25rem; font-weight: 700;}
        .calendar-container { padding: 1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-container { background: var(--bg-white); border-radius: 15px; width: 90%; max-width: 1100px; max-height: 90vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-overlay.active .modal-container { transform: scale(1); }
        .timeline { display: grid; grid-template-columns: 60px 1fr; gap: 1rem; }
        .hour-labels { display: flex; flex-direction: column; text-align: center; }
        .hour-label { height: 40px; font-size: 0.8rem; font-weight: 600; color: #64748b; border-right: 2px solid var(--border-color); padding-top:2px; }
        .time-slots { position: relative; border-radius: 8px; overflow: hidden; background-color: #f8fafc; }
        .time-slot { height: 20px; border-bottom: 1px dashed #e2e8f0a0; cursor: crosshair; position: relative; z-index: 5;}
        #selected-block-overlay { position: absolute; width: 100%; border-radius: 8px; z-index: 10; cursor: grab; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; padding: 4px; line-height: 1.2;}
        .other-booking-block { position: absolute; width: 100%; border-radius: 8px; z-index: 8; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dark); background-color: rgba(209, 213, 219, 0.7); border: 2px solid #9ca3af; cursor: pointer; padding: 4px; line-height: 1.2; }
        .other-booking-block:hover { background-color: rgba(156, 163, 175, 0.7); border-color: #6b7280; }
        #selected-block-overlay:active { cursor: grabbing; }
        #block-name-label, .block-name-label { font-size: 0.85rem; font-weight: bold; }
        #block-time-label, .block-time-label { font-size: 0.75rem; opacity: 0.9; }
        .resize-handle { position: absolute; left: 0; right: 0; height: 10px; z-index: 11; }
        .resize-handle.top { top: -5px; cursor: n-resize; }
        .resize-handle.bottom { bottom: -5px; cursor: s-resize; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--primary-dark); }
        .form-select, .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-white); }
        .toggle-graph-btn { background: #e2e8f0; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.2s; }
        .toggle-graph-btn:hover { background: #cbd5e1; }
    </style>
</head>
<body class="p-0">
<div id="main-wrapper">
    <div class="scrollable-content">
        <div id="dashboard-view">
            <header class="flex justify-between items-center mb-6 pb-4 border-b">
                <div><h1 class="text-3xl font-extrabold text-primary-dark">אזור הלקוח</h1><p id="user-greeting" class="text-slate-600">שלום, לקוח יקר!</p></div>
            </header>
            <div class="dashboard-grid">
                <main class="main-content flex flex-col gap-6">
                    <div class="card">
                        <h2 class="card-title">זמינות ותמחור דינמי</h2>
                        <p class="mb-4 text-slate-600">לחצ/י על תאריך כדי לפתוח את יומן השעות. הנקודות הצבעוניות מייצגות אירועים קיימים. גוון היום משתנה בהתאם לעומס ולתמחור.</p>
                        <div id="calendar-container" class="calendar-container"></div>
                    </div>
                    <div class="card">
                        <h2 class="card-title">ההזמנות שלי</h2>
                        <div id="bookings-table-container" class="overflow-x-auto"></div>
                    </div>
                </main>
                <aside id="sidebar" class="sidebar flex flex-col gap-6"></aside>
            </div>
        </div>
    </div>
    <div id="graph-footer" class="graph-footer-container">
        <div id="histogram-header">
            <h2 id="histogram-title" class="card-title">גרף עומסים</h2>
            <button id="toggle-graph-btn" class="toggle-graph-btn" title="מזער/הרחב גרף">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="graph-container">
            <div id="expanded-graph">
                <svg id="histogram-svg"></svg>
            </div>
        </div>
    </div>
</div>
    
    <!-- Modals -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-container">
            <header class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-lg"><h3 id="modal-title" class="text-xl font-bold text-primary-dark"></h3><button id="modal-close-btn" class="text-2xl text-slate-500 hover:text-danger">&times;</button></header>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 overflow-y-auto">
                <div class="md:col-span-2">
                    <h4 class="font-bold text-lg mb-2">בחירת שעות</h4>
                    <p class="text-sm text-slate-500 mb-4">לחצ/י וגרר/י ליצירת בלוק חדש. לחץ על בלוק קיים כדי לערוך אותו.</p>
                    <div class="timeline">
                        <div class="hour-labels" id="hour-labels"></div>
                        <div class="time-slots" id="time-slots"></div>
                    </div>
                </div>
                <div class="md:col-span-1 flex flex-col gap-4">
                     <div class="card bg-slate-50 p-4">
                        <h4 class="font-bold text-lg mb-3" id="block-form-title">פרטי בלוק</h4>
                        <div class="space-y-4">
                             <div><label for="block-name" class="form-label">שם הבלוק (אופציונלי)</label><input type="text" id="block-name" class="form-input"></div>
                             <div><label for="block-prod-id" class="form-label">שיוך להפקה</label><select id="block-prod-id" class="form-select"></select></div>
                             <div><label for="block-manual-price" class="form-label">תמחור ידני (₪)</label><input type="number" id="block-manual-price" class="form-input" placeholder="אוטומטי לפי שעות"></div>
                             <div id="dynamic-pricing-fields">
                                 <div><label for="block-work-type" class="form-label">סוג עבודה</label><select id="block-work-type" class="form-select"></select></div>
                                 <div><h5 class="form-label">ציוד נלווה</h5><div id="block-equipment" class="space-y-2 max-h-24 overflow-y-auto p-2 bg-white rounded-md border"></div></div>
                            </div>
                             <div><h5 class="form-label">ספקים נוספים</h5><div id="block-suppliers" class="space-y-2 max-h-24 overflow-y-auto p-2 bg-white rounded-md border"></div></div>
                             <hr>
                             <div id="summary-details" class="space-y-2 text-sm"></div>
                        </div>
                        <div class="flex items-center gap-2 mt-4">
                            <button id="save-block-btn" class="flex-grow w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hover:bg-green-700 disabled:bg-gray-400"><i class="fas fa-check mr-2"></i><span>שמור בלוק</span></button>
                            <button id="delete-block-btn" class="hidden w-auto bg-danger text-white font-bold py-2 px-4 rounded-lg transition hover:bg-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i><h3 class="text-xl font-bold text-primary-dark mb-2">שינויים שלא נשמרו</h3>
                <p class="text-slate-600 mb-6">ישנם שינויים שלא נשמרו. האם להמשיך ולבטל אותם?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-discard-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">בטל שינויים</button>
                    <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">המשך עריכה</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DATA STORE & CONFIG ---
        const AppData = {
            entities: {
                productions: {
                    'prod_1': { id: 'prod_1', name: "כנס שנתי 2025"}, 'prod_2': { id: 'prod_2', name: "השקת מוצר"}, 'prod_3': { id: 'prod_3', name: "פסטיבל קיץ"},
                    'prod_4': { id: 'prod_4', name: "צילומי אולפן"}, 'prod_5': { id: 'prod_5', name: "אירוע חברה"}, 'prod_personal': { id: 'prod_personal', name: "אישי"}
                },
                workTypes: {
                    'tech_op': { id: 'tech_op', name: 'מפעיל טכני', baseRate: 80, color: 'rgba(54, 162, 235, 0.8)' },
                    'sound': { id: 'sound', name: 'סאונדמן', baseRate: 120, color: 'rgba(75, 192, 192, 0.8)' },
                    'lighting': { id: 'lighting', name: 'תאורן', baseRate: 150, color: 'rgba(255, 206, 86, 0.8)' },
                    'stage_manager': { id: 'stage_manager', name: 'ניהול במה', baseRate: 300, color: 'rgba(255, 99, 132, 0.8)' },
                    'personal': { id: 'personal', name: 'אישי/סידורים', baseRate: 0, color: 'rgba(156, 163, 175, 0.7)'} 
                },
                equipment: {
                    'projector_1': { id: 'projector_1', name: 'מקרן 10K', price: 800 }, 'mic_set_1': { id: 'mic_set_1', name: 'סט 4 מיקרופונים', price: 450 },
                },
                suppliers: { 'sup_1': {id: 'sup_1', name: 'הגברה חיצונית', cost: 1200} },
                bookings: {} 
            },
            ui: { 
                currentDate: new Date(2025, 5, 1), 
                modal: { isOpen: false, selectedDate: null, editingBlockId: null, isDirty: false, interaction: null }, 
                activeProdId: null, 
                graph: { view: 'monthly', day: null, isExpanded: true } 
            },
            pricing: { cache: {} }
        };

        const PRICING_CONFIG = {
            BASE_WORK_HOURS: 11.5,
            NEIGHBOR_INFLUENCE_DISTANCE: 4, 
            DECAY_FACTOR_K: 1.8,
            MAX_INFLUENCE_MULTIPLIER: 4.5,
            PATTERNS: { standard: (h) => 1.0, morningRush: (h) => (h >= 8 && h < 12) ? 1.2 : 1.0, weekend: (h) => 1.8, weekend_quiet: (h) => 1.3 },
            FATIGUE_THRESHOLD_HOURS: 8,
            FATIGUE_MULTIPLIER_START: 1.2,
            FATIGUE_MULTIPLIER_MAX: 2.5,
            PROXIMITY_CONFIG: {
                WINDOW_MINUTES: 180, 
                MAX_MULTIPLIER: 4.5   
            }
        };

        const DOMElements = {
            body: document.body,
            calendarContainer: document.getElementById('calendar-container'), bookingsTable: document.getElementById('bookings-table-container'), sidebar: document.getElementById('sidebar'),
            graphFooter: document.getElementById('graph-footer'),
            graphContainer: document.getElementById('graph-container'),
            histogramHeader: document.getElementById('histogram-header'),
            expandedGraph: document.getElementById('expanded-graph'),
            histogramSvg: document.getElementById('histogram-svg'),
            histogramTitle: document.getElementById('histogram-title'), 
            toggleGraphBtn: document.getElementById('toggle-graph-btn'),
            modal: {
                overlay: document.getElementById('booking-modal'), title: document.getElementById('modal-title'), closeBtn: document.getElementById('modal-close-btn'), formTitle: document.getElementById('block-form-title'),
                blockNameInput: document.getElementById('block-name'), prodIdSelect: document.getElementById('block-prod-id'),
                manualPriceInput: document.getElementById('block-manual-price'), dynamicPricingFields: document.getElementById('dynamic-pricing-fields'),
                workTypeSelect: document.getElementById('block-work-type'), equipmentContainer: document.getElementById('block-equipment'), suppliersContainer: document.getElementById('block-suppliers'),
                summaryDetails: document.getElementById('summary-details'), saveBtn: document.getElementById('save-block-btn'), saveBtnLabel: document.querySelector('#save-block-btn span'), deleteBtn: document.getElementById('delete-block-btn'), 
                hourLabels: document.getElementById('hour-labels'), timeSlots: document.getElementById('time-slots'),
            },
            confirmModal: { overlay: document.getElementById('confirm-modal'), discardBtn: document.getElementById('confirm-discard-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') }
        };
        let liveBlockState = null;

        // --- HELPER & UTILITY FUNCTIONS ---
        const timeToMinutes = (time) => !time ? 0 : (time.split(':').map(Number).reduce((h, m) => h * 60 + m));
        const minutesToTime = (minutes) => `${String(Math.floor(minutes / 60)).padStart(2,'0')}:${String(minutes % 60).padStart(2,'0')}`;
        const timeAdd = (time, min) => minutesToTime(timeToMinutes(time) + min);

        function rateToColor(rate, baseRate, asRgb = false) {
            const ratio = Math.max(0.1, rate / baseRate);
            const success = [16, 185, 129], warning = [245, 158, 11], danger = [239, 68, 68], scream = [255, 17, 17];
            let r, g, b;

            if (ratio <= 1.25) {
                const p = ratio / 1.25; r = Math.round(240 + p * (success[0] - 240)); g = Math.round(240 + p * (success[1] - 240)); b = Math.round(240 + p * (success[2] - 240));
            } else if (ratio <= 2.5) {
                const p = (ratio - 1.25) / 1.25; r = Math.round(success[0] + p * (warning[0] - success[0])); g = Math.round(success[1] + p * (warning[1] - success[1])); b = Math.round(success[2] + p * (warning[2] - success[2]));
            } else if (ratio <= 4) {
                const p = (ratio - 2.5) / 1.5; r = Math.round(warning[0] + p * (scream[0] - warning[0])); g = Math.round(warning[1] + p * (scream[1] - warning[1])); b = Math.round(warning[2] + p * (scream[2] - warning[2]));
            } else {
                [r,g,b] = scream;
            }
            if (asRgb) return `${r}, ${g}, ${b}`;
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        function generateRandomErrands(year, month) {
            const errandsCount = Math.floor(Math.random() * 4) + 3;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const errandNames = ["רופא", "סידורים", "בנק", "קניות", "זמן משפחה", "חופש", "בית", "לימודים"];
            for (let i = 0; i < errandsCount; i++) {
                const day = Math.floor(Math.random() * daysInMonth) + 1;
                const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                const isLongErrand = Math.random() < 0.25;
                let startHour, endHour;
                if (isLongErrand) { startHour = Math.floor(Math.random() * 4) + 8; endHour = startHour + Math.floor(Math.random() * 3) + 7; } 
                else { startHour = Math.floor(Math.random() * 8) + 9; endHour = startHour + (Math.random() > 0.5 ? 1 : 2); }
                endHour = Math.min(endHour, 22);
                const blockId = `b_personal_${i}_${Date.now()}`;
                AppData.entities.bookings[blockId] = { blockId, name: errandNames[Math.floor(Math.random() * errandNames.length)], date: dateStr, prodId: 'prod_personal', workTypeId: 'personal', equipmentIds: [], supplierIds:[], manualPrice: null, start: minutesToTime(startHour * 60), end: minutesToTime(endHour * 60) };
            }
        }

        // --- DYNAMIC PRICING ENGINE ---
        function getTotalDailyWorkHours(dateStr) {
            const bookingsOnDay = Object.values(AppData.entities.bookings).filter(b => b.date === dateStr);
            return bookingsOnDay.reduce((total, b) => {
                if (!b.start || !b.end) return total;
                return total + (timeToMinutes(b.end) - timeToMinutes(b.start)) / 60;
            }, 0);
        }

        function calculateBaseBlockValue(block) {
            if (!block || !block.start || !block.end) return 0;
            if (block.manualPrice != null && block.manualPrice > 0) return parseFloat(block.manualPrice);
            const workType = AppData.entities.workTypes[block.workTypeId];
            if (!workType) return 0;
            const durationHours = (timeToMinutes(block.end) - timeToMinutes(block.start)) / 60;
            if (workType.id === 'personal') { return (durationHours >= 6) ? AppData.entities.workTypes['tech_op'].baseRate * PRICING_CONFIG.BASE_WORK_HOURS * 0.5 : AppData.entities.workTypes['tech_op'].baseRate * durationHours * 0.25; }
            const hourlyPrice = durationHours * workType.baseRate;
            const equipmentPrice = (block.equipmentIds || []).reduce((acc, eqId) => acc + (AppData.entities.equipment[eqId]?.price || 0), 0);
            return hourlyPrice + equipmentPrice;
        }

        function getDailyLoad(date) {
            const dateStr = date.toISOString().split('T')[0];
            const bookingsOnDay = Object.values(AppData.entities.bookings).filter(b => b.date === dateStr);
            if (bookingsOnDay.length === 0) return 0;
            const totalValue = bookingsOnDay.reduce((acc, b) => acc + calculateBaseBlockValue(b), 0);
            const equivalentHours = totalValue / AppData.entities.workTypes['tech_op'].baseRate;
            return equivalentHours / PRICING_CONFIG.BASE_WORK_HOURS;
        }

        function getNeighborModifier(date) {
            const dateStr = date.toISOString().split('T')[0];
            if (AppData.pricing.cache[dateStr]) return AppData.pricing.cache[dateStr];
            let totalInfluence = 0;
            for (let i = -PRICING_CONFIG.NEIGHBOR_INFLUENCE_DISTANCE; i <= PRICING_CONFIG.NEIGHBOR_INFLUENCE_DISTANCE; i++) {
                if (i === 0) continue;
                const neighborDate = new Date(date);
                neighborDate.setDate(date.getDate() + i);
                const distance = Math.abs(i);
                const influence = getDailyLoad(neighborDate) / Math.pow(distance, PRICING_CONFIG.DECAY_FACTOR_K);
                totalInfluence += influence;
            }
            const modifier = 1 + Math.min(totalInfluence, PRICING_CONFIG.MAX_INFLUENCE_MULTIPLIER);
            AppData.pricing.cache[dateStr] = modifier;
            return modifier;
        }
        
        function getDensityAndFatigueMultiplier(date, hour) {
            const dateStr = date.toISOString().split('T')[0];
            const totalWorkHours = getTotalDailyWorkHours(dateStr);
            if (totalWorkHours < PRICING_CONFIG.FATIGUE_THRESHOLD_HOURS) return 1.0;
            const bookingsBeforeHour = Object.values(AppData.entities.bookings).filter(b => b.date === dateStr && timeToMinutes(b.end) <= hour * 60);
            const workHoursBeforeNow = bookingsBeforeHour.reduce((total, b) => total + (timeToMinutes(b.end) - timeToMinutes(b.start)) / 60, 0);
            if (workHoursBeforeNow < PRICING_CONFIG.FATIGUE_THRESHOLD_HOURS) return 1.0;
            const { FATIGUE_THRESHOLD_HOURS, FATIGUE_MULTIPLIER_START, FATIGUE_MULTIPLIER_MAX } = PRICING_CONFIG;
            const progress = (workHoursBeforeNow - FATIGUE_THRESHOLD_HOURS) / (PRICING_CONFIG.BASE_WORK_HOURS - FATIGUE_THRESHOLD_HOURS);
            const multiplier = FATIGUE_MULTIPLIER_START + progress * (FATIGUE_MULTIPLIER_MAX - FATIGUE_MULTIPLIER_START);
            return Math.min(Math.max(1.0, multiplier), FATIGUE_MULTIPLIER_MAX);
        }
        
        function getProximityMultiplier(date, timeInMinutes) {
            const dateStr = date.toISOString().split('T')[0];
            const bookingsOnDay = Object.values(AppData.entities.bookings).filter(b => b.date === dateStr && b.workTypeId !== 'personal');
            if(bookingsOnDay.length === 0) return 1.0;
            let minDistance = PRICING_CONFIG.PROXIMITY_CONFIG.WINDOW_MINUTES;
            for(const block of bookingsOnDay) {
                const startMins = timeToMinutes(block.start);
                const endMins = timeToMinutes(block.end);
                if(timeInMinutes >= startMins && timeInMinutes <= endMins) return PRICING_CONFIG.PROXIMITY_CONFIG.MAX_MULTIPLIER;
                const distToStart = Math.abs(timeInMinutes - startMins);
                const distToEnd = Math.abs(timeInMinutes - endMins);
                minDistance = Math.min(minDistance, distToStart, distToEnd);
            }
            if (minDistance >= PRICING_CONFIG.PROXIMITY_CONFIG.WINDOW_MINUTES) return 1.0;
            const proximityFactor = 1.0 - (minDistance / PRICING_CONFIG.PROXIMITY_CONFIG.WINDOW_MINUTES);
            return 1.0 + proximityFactor * (PRICING_CONFIG.PROXIMITY_CONFIG.MAX_MULTIPLIER - 1.0);
        }

        function getHourlyRate(date, time, workTypeId) {
            const hour = parseInt(time.split(':')[0]);
            const minutes = timeToMinutes(time);
            const workType = AppData.entities.workTypes[workTypeId];
            if (!workType || workType.baseRate === 0) return 0;
            const baseRate = workType.baseRate;
            const dayOfWeek = date.getDay();
            let patternKey = 'standard';
            if (dayOfWeek === 5 || dayOfWeek === 6) patternKey = getDailyLoad(date) > 0.1 ? 'weekend' : 'weekend_quiet';
            const timeMultiplier = (PRICING_CONFIG.PATTERNS[patternKey] || PRICING_CONFIG.PATTERNS['standard'])(hour);
            const fatigueMultiplier = getDensityAndFatigueMultiplier(date, hour);
            const proximityMultiplier = getProximityMultiplier(date, minutes);
            return baseRate * timeMultiplier * getNeighborModifier(date) * fatigueMultiplier * proximityMultiplier;
        }

        function calculateBlockPrice(block, date) {
            if (!block || !block.start || !block.end) return 0;
            if (block.manualPrice != null && !isNaN(block.manualPrice) && block.manualPrice > 0) return parseFloat(block.manualPrice);
            if(block.workTypeId === 'personal') return 0;
            let totalCost = 0;
            const startMins = timeToMinutes(block.start);
            const endMins = timeToMinutes(block.end);
            for (let min = startMins; min < endMins; min += 30) totalCost += getHourlyRate(date, minutesToTime(min), block.workTypeId) * 0.5;
            const equipmentPrice = (block.equipmentIds || []).reduce((acc, eqId) => acc + (AppData.entities.equipment[eqId]?.price || 0), 0);
            return totalCost + equipmentPrice;
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() { 
            AppData.pricing.cache = {}; 
            renderCalendar(); 
            renderBookingsTable(); 
            renderSidebar(); 
            renderGraph();
        }
        
        function renderCalendar() {
            const { currentDate } = AppData.ui; const year = currentDate.getFullYear(), month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            let html = `<div class="calendar-header"><button class="p-2" data-nav="prev"><i class="fas fa-chevron-left"></i></button><h3>${firstDayOfMonth.toLocaleDateString('he-IL', {month:'long', year:'numeric'})}</h3><button class="p-2" data-nav="next"><i class="fas fa-chevron-right"></i></button></div>`;
            html += `<div class="grid grid-cols-7 gap-1 text-center font-bold text-slate-500 text-sm mb-2">` + ['א','ב','ג','ד','ה','ו','ש'].map(d => `<div>${d}</div>`).join('') + `</div><div class="grid grid-cols-7 gap-1">`;
            for (let i = 0; i < firstDayOfMonth.getDay(); i++) html += `<div class="calendar-day other-month"></div>`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const baseRate = AppData.entities.workTypes['tech_op'].baseRate;
            for(let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                let dayPrice = 0;
                for (let h = 8; h < 19; h++) dayPrice += getHourlyRate(date, `${String(h).padStart(2, '0')}:00`, 'tech_op');
                dayPrice += getHourlyRate(date, '19:00', 'tech_op') * 0.5;
                const avgRateForDay = dayPrice / PRICING_CONFIG.BASE_WORK_HOURS;
                const priceColor = rateToColor(avgRateForDay, baseRate);
                const bgColor = rateToColor(avgRateForDay, baseRate, true);
                const backgroundStyle = `background-color: rgba(${bgColor}, 0.25);`;
                const activeBookings = Object.values(AppData.entities.bookings).filter(b => b.date === date.toISOString().split('T')[0]);
                let eventsHtml = '<div class="day-events">';
                if (activeBookings.length > 0) [ ...new Set(activeBookings.map(b => b.workTypeId))].slice(0, 3).forEach(wtId => { const workType = AppData.entities.workTypes[wtId]; if(workType) eventsHtml += `<div class="event-chip" style="background-color:${workType.color}"></div>`; });
                eventsHtml += '</div>';
                html += `<div class="calendar-day" data-day="${i}" style="${backgroundStyle}"><div class="day-number">${i}</div>${eventsHtml}<div class="price" style="color:${priceColor}">₪${Math.round(dayPrice)}</div></div>`;
            }
            html += '</div>'; DOMElements.calendarContainer.innerHTML = html;
        }

        function renderBookingsTable() { 
            let html = `<table class="w-full text-sm text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 rounded-t-lg"><tr><th class="px-6 py-3">שם/הפקה</th><th class="px-6 py-3">תאריך</th><th class="px-6 py-3">שעות</th><th class="px-6 py-3">פעולות</th></tr></thead><tbody>`;
            const allBookings = Object.values(AppData.entities.bookings).sort((a,b) => new Date(a.date) - new Date(b.date));
            if (allBookings.length === 0) html += '<tr><td colspan="4" class="text-center p-8 text-slate-500">אין עדיין הזמנות.</td></tr>';
            else for (const block of allBookings) { const production = AppData.entities.productions[block.prodId]; html += `<tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" data-block-id="${block.blockId}" data-prod-id="${block.prodId}"><td class="px-6 py-4 font-semibold">${block.name || `<em>${production?.name || ''}</em>`}</td><td class="px-6 py-4">${new Date(block.date + 'T00:00:00').toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'})}</td><td class="px-6 py-4">${block.start || ''} - ${block.end || ''}</td><td class="px-6 py-4"><button class="text-blue-600 hover:underline" data-action="edit" data-block-id="${block.blockId}">ערוך</button></td></tr>`; }
            html += `</tbody></table>`;
            DOMElements.bookingsTable.innerHTML = html;
        }
        
        function renderSidebar() {
            const prodId = AppData.ui.activeProdId;
            const production = prodId ? AppData.entities.productions[prodId] : null;
            if (!prodId || !production) { DOMElements.sidebar.innerHTML = `<div class="card"><h2 class="card-title">בחרו הפקה</h2><p class="text-slate-500">לחצו על שורה בטבלת ההזמנות כדי לראות את פרטי ההפקה המשוייכת.</p></div>`; return; }
            const bookingsForProd = Object.values(AppData.entities.bookings).filter(b => b.prodId === prodId);
            DOMElements.sidebar.innerHTML = `<div class="card"><h2 class="card-title">פרטי הפקה: <span class="text-primary-purple">${production.name}</span></h2></div>`;
        }
        
        function renderGraph() {
            DOMElements.graphFooter.classList.toggle('minimized', !AppData.ui.graph.isExpanded);
            const icon = DOMElements.toggleGraphBtn.querySelector('i');
            icon.classList.toggle('fa-chevron-down', AppData.ui.graph.isExpanded);
            icon.classList.toggle('fa-chevron-up', !AppData.ui.graph.isExpanded);

            DOMElements.histogramHeader.style.background = 'none';
            DOMElements.histogramTitle.style.position = 'static';
            DOMElements.histogramTitle.style.transform = 'none';
            DOMElements.histogramTitle.style.color = 'var(--primary-dark)';
            DOMElements.histogramTitle.style.textShadow = 'none';

            if (AppData.ui.graph.isExpanded) {
                DOMElements.graphContainer.classList.remove('hidden');
                renderExpandedGraph();
            } else {
                DOMElements.graphContainer.classList.add('hidden');
                renderMinimizedGraph();
            }
        }

        function renderMinimizedGraph() {
            const { currentDate } = AppData.ui;
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const baseRate = AppData.entities.workTypes['tech_op'].baseRate;

            const colorStops = [];
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                let dayPrice = 0;
                for (let h = 8; h < 19; h++) dayPrice += getHourlyRate(date, `${h}:00`, 'tech_op');
                const avgRateForDay = dayPrice / PRICING_CONFIG.BASE_WORK_HOURS;
                colorStops.push(rateToColor(avgRateForDay, baseRate));
            }
            
            DOMElements.histogramHeader.style.background = `linear-gradient(to left, ${colorStops.join(', ')})`;
            DOMElements.histogramTitle.textContent = `עומס חודשי - ${currentDate.toLocaleDateString('he-IL', {month:'long', year:'numeric'})}`;
            DOMElements.histogramTitle.style.position = 'absolute';
            DOMElements.histogramTitle.style.left = '50%';
            DOMElements.histogramTitle.style.top = '50%';
            DOMElements.histogramTitle.style.transform = 'translate(-50%, -50%)';
            DOMElements.histogramTitle.style.color = 'white';
            DOMElements.histogramTitle.style.textShadow = '0 1px 3px rgba(0,0,0,0.6)';
        }
        
        function renderExpandedGraph() {
            const { view, day } = AppData.ui.graph;
            const date = (view === 'daily' && day) 
                ? new Date(AppData.ui.currentDate.getFullYear(), AppData.ui.currentDate.getMonth(), day)
                : AppData.ui.currentDate;
            
            DOMElements.histogramTitle.textContent = (view === 'daily') ? `פירוט שעתי - ${date.toLocaleDateString('he-IL')}` : 'גרף עומסים חודשי';

            const svg = DOMElements.histogramSvg;
            svg.innerHTML = '';
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            if (width === 0 || height === 0) return;

            const baseRate = AppData.entities.workTypes['tech_op'].baseRate;
            
            const pricePoints = [];
            let maxPrice = baseRate * 1.5;
            let barData = { defs: [], rects: [] };
            
            if (view === 'daily') {
                const blocksOnDay = Object.values(AppData.entities.bookings).filter(b => b.date === date.toISOString().split('T')[0] && b.workTypeId !== 'personal');
                
                for (let m = 0; m <= 24 * 60; m += 30) {
                    const isBooked = blocksOnDay.some(block => {
                        const startMins = timeToMinutes(block.start);
                        const endMins = timeToMinutes(block.end);
                        return m >= startMins && m < endMins;
                    });
                    
                    const rate = isBooked ? 0 : getHourlyRate(date, minutesToTime(m), 'tech_op');
                    pricePoints.push(rate);
                    if (rate > maxPrice) maxPrice = rate;
                }
                
                barData = blocksOnDay.map(block => {
                    const gradientId = `grad_${block.blockId}`;
                    const startRate = getHourlyRate(date, block.start, block.workTypeId);
                    const endRate = getHourlyRate(date, timeAdd(block.end, -30), block.workTypeId);
                    const startColor = rateToColor(startRate, baseRate);
                    const endColor = rateToColor(endRate, baseRate);
                    
                    const def = `<linearGradient id="${gradientId}" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="${startColor}"/><stop offset="100%" stop-color="${endColor}"/></linearGradient>`;
                    
                    const x = (timeToMinutes(block.start) / (24 * 60)) * width;
                    const w = ((timeToMinutes(block.end) - timeToMinutes(block.start)) / (24 * 60)) * width;
                    const rect = `<rect fill="url(#${gradientId})" opacity="0.85" x="${x}" y="0" width="${w}" height="${height}"></rect>`;
                    
                    return { def, rect };
                }).reduce((acc, curr) => {
                    acc.defs.push(curr.def);
                    acc.rects.push(curr.rect);
                    return acc;
                }, { defs: [], rects: [] });

            } else { // Monthly view
                const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const dailyHours = [];
                let maxHours = 12;

                for (let i = 1; i <= daysInMonth; i++) {
                    const d = new Date(date.getFullYear(), date.getMonth(), i);
                    let dayPrice = 0;
                    for (let h = 8; h < 19; h++) dayPrice += getHourlyRate(d, `${h}:00`, 'tech_op');
                    pricePoints.push(dayPrice);
                    if (dayPrice > maxPrice) maxPrice = dayPrice;
                    const hours = getTotalDailyWorkHours(d.toISOString().split('T')[0]);
                    dailyHours.push(hours);
                    if (hours > maxHours) maxHours = hours;
                }

                 const barWidth = width / (daysInMonth * 2);
                 barData.rects = dailyHours.map((hours, i) => {
                    if (hours === 0) return '';
                    const barHeight = (hours / maxHours) * height;
                    const x = ((i * 2 + 0.5) * barWidth);
                    return `<rect class="monthly-hours-bar" x="${x}" y="${height - barHeight}" width="${barWidth}" height="${barHeight}"></rect>`;
                 });
            }

            const toPath = (p, isArea) => {
                if (p.length === 0) return '';
                let path = `M 0,${height - Math.max(0, (p[0] / maxPrice) * height)}`;
                for (let i = 1; i < p.length; i++) {
                    const x = (i / (p.length - 1)) * width;
                    const y = height - Math.max(0, (p[i] / maxPrice) * height);
                    path += ` L ${x},${y}`;
                }
                if (isArea) path += ` L ${width},${height} L 0,${height} Z`;
                return path;
            };

            const areaString = toPath(pricePoints, true);
            const pathString = toPath(pricePoints, false);

            const defs = `<defs>${barData.defs.join('')}<linearGradient id="price-gradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--warning)" stop-opacity="0.4"/><stop offset="100%" stop-color="var(--warning)" stop-opacity="0.05"/></linearGradient></defs>`;
            
            svg.innerHTML = defs + barData.rects.join('') + `<path class="price-path" d="${areaString}"></path>` + `<path class="price-path" d="${pathString}" fill="none"></path>`;
        }
        
        // --- MODAL & INTERACTION ---
        function openModal(date, blockId = null) {
            AppData.ui.graph.view = 'daily';
            AppData.ui.graph.day = date.getDate();
            if(!AppData.ui.graph.isExpanded) {
                AppData.ui.graph.isExpanded = true;
            }
            renderGraph();

            AppData.ui.modal.isOpen = true; AppData.ui.modal.selectedDate = date; AppData.ui.modal.editingBlockId = blockId;
            liveBlockState = blockId ? JSON.parse(JSON.stringify(AppData.entities.bookings[blockId])) : createNewBlockTemplate();
            renderModalContent(); 
            DOMElements.modal.overlay.classList.add('active');
        }
        function forceCloseModal() {
            AppData.ui.graph.view = 'monthly';
            renderGraph();
            DOMElements.modal.overlay.classList.remove('active');
            AppData.ui.modal = { isOpen: false, selectedDate: null, editingBlockId: null, isDirty: false, interaction: null };
            liveBlockState = null; 
            renderAll();
        }
        function requestCloseModal() { if (AppData.ui.modal.isDirty) DOMElements.confirmModal.overlay.classList.add('active'); else forceCloseModal(); }
        function saveBlock() {
            if (!liveBlockState) return;
            AppData.entities.bookings[liveBlockState.blockId] = { ...liveBlockState };
            if (!AppData.ui.modal.editingBlockId) AppData.ui.modal.editingBlockId = liveBlockState.blockId;
            AppData.ui.modal.isDirty = false;
            renderAll();
            renderTimeline(); 
            const btn = DOMElements.modal.saveBtn;
            btn.classList.replace('bg-green-600', 'bg-blue-500');
            DOMElements.modal.saveBtnLabel.textContent = "נשמר!"; btn.disabled = true;
            setTimeout(() => { DOMElements.modal.saveBtnLabel.textContent = "שמור בלוק"; btn.classList.replace('bg-blue-500', 'bg-green-600'); btn.disabled = false; }, 1500);
        }
        function deleteBlock() { if (AppData.ui.modal.editingBlockId) delete AppData.entities.bookings[AppData.ui.modal.editingBlockId]; forceCloseModal(); }
        function createNewBlockTemplate() {
            const date = AppData.ui.modal.selectedDate;
            return { blockId: `b_${Date.now()}`, name: '', date: date.toISOString().split('T')[0], prodId: 'prod_personal', workTypeId: 'tech_op', equipmentIds: [], supplierIds: [], manualPrice: null, start: null, end: null };
        }
        function switchActiveBlock(blockId) {
            function proceed() { AppData.ui.modal.isDirty = false; AppData.ui.modal.editingBlockId = blockId; liveBlockState = JSON.parse(JSON.stringify(AppData.entities.bookings[blockId])); renderModalContent(); }
            if (AppData.ui.modal.isDirty) { DOMElements.confirmModal.overlay.classList.add('active'); DOMElements.confirmModal.discardBtn.onclick = () => { DOMElements.confirmModal.overlay.classList.remove('active'); proceed(); }; } 
            else { proceed(); }
        }
        function renderTimeline(){
            const { selectedDate } = AppData.ui.modal; 
            const { timeSlots } = DOMElements.modal;
            
            timeSlots.innerHTML = ''; 
            
            const baseRate = AppData.entities.workTypes['tech_op'].baseRate;
            let backgroundHtml = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 2; m++) {
                    const time = `${String(h).padStart(2,'0')}:${m===0?'00':'30'}`;
                    const rate = getHourlyRate(selectedDate, time, 'tech_op');
                    const color = rateToColor(rate, baseRate, true);
                    backgroundHtml += `<div class="time-slot" data-time="${time}" style="background-color: rgba(${color}, 0.6)"></div>`;
                }
            }
            timeSlots.style.background = 'none';
            timeSlots.innerHTML = backgroundHtml;
            
            const dateStr = selectedDate.toISOString().split('T')[0];
            Object.values(AppData.entities.bookings).filter(b => b.date === dateStr).forEach(block => {
                if (liveBlockState && block.blockId === liveBlockState.blockId) return;
                if (!block.start || !block.end) return;
                const blockEl = document.createElement('div');
                blockEl.className = 'other-booking-block'; blockEl.dataset.blockId = block.blockId;
                blockEl.innerHTML = `<span class="block-name-label">${block.name||'...'}</span><span class="block-time-label">${block.start} - ${block.end}</span>`;
                const startSlot = timeSlots.querySelector(`[data-time="${block.start}"]`), endSlot = timeSlots.querySelector(`[data-time="${timeAdd(block.end,-30)}"]`);
                if(startSlot && endSlot) {
                    blockEl.style.top = `${startSlot.offsetTop}px`;
                    blockEl.style.height = `${(endSlot.offsetTop + endSlot.offsetHeight) - startSlot.offsetTop}px`;
                    const workType = AppData.entities.workTypes[block.workTypeId];
                    if(workType) blockEl.style.borderColor = workType.color.replace(/, 0\.\d+\)/, ', 1)');
                    timeSlots.appendChild(blockEl);
                }
            });

            if (liveBlockState && liveBlockState.start) {
                const blockEl = document.createElement('div');
                blockEl.id = 'selected-block-overlay'; blockEl.dataset.blockId = liveBlockState.blockId;
                blockEl.innerHTML = `<div class="resize-handle top"></div><span id="block-name-label"></span><span id="block-time-label"></span><div class="resize-handle bottom"></div>`;
                timeSlots.appendChild(blockEl);
                updateSelectedBlockUI(liveBlockState);
            }
        }
        function getBlockStateFromUI() {
            return { name: DOMElements.modal.blockNameInput.value, prodId: DOMElements.modal.prodIdSelect.value, manualPrice: DOMElements.modal.manualPriceInput.value ? parseFloat(DOMElements.modal.manualPriceInput.value) : null, workTypeId: DOMElements.modal.workTypeSelect.value, equipmentIds: Array.from(DOMElements.modal.equipmentContainer.querySelectorAll('input:checked')).map(el => el.value), supplierIds: Array.from(DOMElements.modal.suppliersContainer.querySelectorAll('input:checked')).map(el => el.value) };
        }
        function renderModalContent() {
            const { selectedDate } = AppData.ui.modal; const { modal } = DOMElements;
            modal.title.textContent = `הזמנה עבור: ${selectedDate.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            modal.prodIdSelect.innerHTML = Object.values(AppData.entities.productions).map(p => `<option value="${p.id}" ${liveBlockState.prodId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            modal.workTypeSelect.innerHTML = Object.values(AppData.entities.workTypes).map(wt => `<option value="${wt.id}" ${liveBlockState.workTypeId === wt.id ? 'selected' : ''}>${wt.name}</option>`).join('');
            modal.equipmentContainer.innerHTML = Object.values(AppData.entities.equipment).map(eq => `<label class="flex items-center gap-2 p-1"><input type="checkbox" value="${eq.id}" class="form-checkbox" ${(liveBlockState.equipmentIds||[]).includes(eq.id)?'checked':''}><span>${eq.name} (+₪${eq.price})</span></label>`).join('');
            modal.suppliersContainer.innerHTML = Object.values(AppData.entities.suppliers).map(s => `<label class="flex items-center gap-2 p-1"><input type="checkbox" value="${s.id}" class="form-checkbox" ${(liveBlockState.supplierIds||[]).includes(s.id)?'checked':''}><span>${s.name} (+₪${s.cost})</span></label>`).join('');
            modal.hourLabels.innerHTML = Array.from({length: 24}, (_, h) => `<div class="hour-label">${String(h).padStart(2,'0')}:00</div>`).join('');
            renderTimeline(); updateModalForm();
        }
        function updateModalForm() {
            const { modal } = DOMElements; const block = liveBlockState;
            modal.formTitle.textContent = AppData.ui.modal.editingBlockId && AppData.entities.bookings[AppData.ui.modal.editingBlockId] ? 'עריכת בלוק קיים' : 'הוספת בלוק חדש';
            modal.deleteBtn.classList.toggle('hidden', !(AppData.ui.modal.editingBlockId && AppData.entities.bookings[AppData.ui.modal.editingBlockId]));
            modal.blockNameInput.value = block.name || ""; modal.manualPriceInput.value = block.manualPrice || "";
            modal.prodIdSelect.value = block.prodId; modal.workTypeSelect.value = block.workTypeId;
            toggleManualPriceFields(); updateSelectedBlockUI(block); updateSummaryAndSaveState(block);
        }
        function toggleManualPriceFields() { const isManual = DOMElements.modal.manualPriceInput.value > 0; DOMElements.modal.dynamicPricingFields.style.opacity = isManual ? '0.5':'1'; DOMElements.modal.dynamicPricingFields.style.pointerEvents = isManual ? 'none':'auto'; }
        function updateSelectedBlockUI(block) {
            const overlay = DOMElements.modal.timeSlots.querySelector('#selected-block-overlay');
            if (!block || !block.start || !block.end || !overlay) { if(overlay) overlay.classList.add('hidden'); return; }
            overlay.classList.remove('hidden');
            const startSlot = DOMElements.modal.timeSlots.querySelector(`[data-time="${block.start}"]`), endSlot = DOMElements.modal.timeSlots.querySelector(`[data-time="${timeAdd(block.end, -30)}"]`);
            if(startSlot && endSlot) {
                overlay.style.top = `${startSlot.offsetTop}px`;
                overlay.style.height = `${(endSlot.offsetTop + endSlot.offsetHeight) - startSlot.offsetTop}px`;
                const workType = AppData.entities.workTypes[block.workTypeId];
                if(workType) { overlay.style.backgroundColor = workType.color; overlay.style.border = `2px solid ${workType.color.replace(/, 0\.\d+\)/, ', 1)')}`; }
                overlay.querySelector('#block-name-label').textContent = block.name || '';
                overlay.querySelector('#block-time-label').textContent = `${block.start} - ${block.end}`;
            }
        }
        function updateSummaryAndSaveState(block) {
            const price = calculateBlockPrice(block, AppData.ui.modal.selectedDate);
            DOMElements.modal.summaryDetails.innerHTML = (!block.start||!block.end)?'<p class="text-center text-slate-500">גרור/י כדי לבחור טווח שעות</p>':`<div class="flex justify-between"><span>זמן:</span><span class="font-semibold">${block.start} - ${block.end}</span></div><div class="flex justify-between font-bold text-lg"><span>עלות סופית:</span><span>₪${price.toFixed(0)}</span></div>`;
            DOMElements.modal.saveBtn.disabled = !block.start || !block.end;
        }
        function handleFormChange() { AppData.ui.modal.isDirty = true; const changes = getBlockStateFromUI(); liveBlockState={...liveBlockState, ...changes}; updateModalForm(); }
        
        function init() {
            const { currentDate } = AppData.ui;
            generateRandomErrands(currentDate.getFullYear(), currentDate.getMonth());
            renderAll();
            
            DOMElements.toggleGraphBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                AppData.ui.graph.isExpanded = !AppData.ui.graph.isExpanded;
                if (!AppData.ui.graph.isExpanded) {
                    AppData.ui.graph.view = 'monthly';
                }
                renderGraph();
            });
            
            DOMElements.histogramHeader.addEventListener('click', () => {
                 if(!AppData.ui.graph.isExpanded) {
                    AppData.ui.graph.isExpanded = true;
                    renderGraph();
                 }
            });


            DOMElements.calendarContainer.addEventListener('click', e => {
                const dayEl = e.target.closest('.calendar-day:not(.other-month)'), navEl = e.target.closest('[data-nav]');
                if(dayEl) openModal(new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(dayEl.dataset.day)));
                if(navEl) { currentDate.setMonth(currentDate.getMonth() + (navEl.dataset.nav === 'next' ? 1 : -1)); AppData.entities.bookings = {}; generateRandomErrands(currentDate.getFullYear(), currentDate.getMonth()); renderAll(); }
            });

            DOMElements.bookingsTable.addEventListener('click', e => {
                const editBtn = e.target.closest('[data-action="edit"]'), row = e.target.closest('tr[data-block-id]');
                if (editBtn) { const { blockId } = editBtn.dataset; const blockToEdit = AppData.entities.bookings[blockId]; if (blockToEdit) openModal(new Date(blockToEdit.date + 'T12:00:00'), blockId); }
                else if (row) { AppData.ui.activeProdId = row.dataset.prodId; renderSidebar(); }
            });

            DOMElements.modal.closeBtn.addEventListener('click', requestCloseModal);
            DOMElements.modal.overlay.addEventListener('click', e => { if(e.target === DOMElements.modal.overlay) requestCloseModal(); });
            DOMElements.modal.saveBtn.addEventListener('click', saveBlock);
            DOMElements.modal.deleteBtn.addEventListener('click', deleteBlock);
            
            [DOMElements.modal.manualPriceInput, DOMElements.modal.blockNameInput, DOMElements.modal.prodIdSelect, DOMElements.modal.workTypeSelect].forEach(el => el.addEventListener('input', handleFormChange));
            [DOMElements.modal.equipmentContainer, DOMElements.modal.suppliersContainer].forEach(el => el.addEventListener('change', handleFormChange));

            DOMElements.confirmModal.cancelBtn.addEventListener('click', () => DOMElements.confirmModal.overlay.classList.remove('active'));
            DOMElements.confirmModal.discardBtn.addEventListener('click', () => { DOMElements.confirmModal.overlay.classList.remove('active'); if (DOMElements.confirmModal.discardBtn.onclick) { DOMElements.confirmModal.discardBtn.onclick(); DOMElements.confirmModal.discardBtn.onclick = null; } else { forceCloseModal(); } });

            const timeSlotsContainer = DOMElements.modal.timeSlots;
            timeSlotsContainer.addEventListener('mousedown', e => {
                if (AppData.ui.modal.interaction) return;
                let interactionType;
                const targettedBlock = e.target.closest('#selected-block-overlay, .other-booking-block');
                if (targettedBlock) {
                    if (targettedBlock.id === 'selected-block-overlay') interactionType = e.target.classList.contains('resize-handle') ? (e.target.classList.contains('top') ? 'resize-start' : 'resize-end') : 'drag';
                    else { switchActiveBlock(targettedBlock.dataset.blockId); return; }
                } else if (e.target.classList.contains('time-slot')) interactionType = 'create-drag'; 
                else return;
                e.preventDefault(); AppData.ui.modal.isDirty = true;
                const rect = timeSlotsContainer.getBoundingClientRect(); const y = e.clientY - rect.top;
                if (interactionType === 'create-drag') {
                    liveBlockState = createNewBlockTemplate();
                    const timeIndex = Math.floor(y / timeSlotsContainer.querySelector('.time-slot').offsetHeight);
                    const clickedTime = minutesToTime(timeIndex * 30);
                    liveBlockState.start = clickedTime; liveBlockState.end = timeAdd(clickedTime, 30);
                    renderTimeline(); updateModalForm();
                }
                AppData.ui.modal.interaction = { type: interactionType, startY: y, originalStartMin: timeToMinutes(liveBlockState.start), originalEndMin: timeToMinutes(liveBlockState.end) };
            });

            window.addEventListener('mousemove', e => {
                const interaction = AppData.ui.modal.interaction; if (!interaction || !liveBlockState) return; e.preventDefault();
                const rect = timeSlotsContainer.getBoundingClientRect(); const dy = e.clientY - rect.top - interaction.startY;
                const dMinutes = Math.round(dy / (timeSlotsContainer.offsetHeight / (24 * 2))) * 30;
                let newStartMin = interaction.originalStartMin, newEndMin = interaction.originalEndMin;
                if (interaction.type === 'drag') { newStartMin += dMinutes; newEndMin += dMinutes; } 
                else if (interaction.type === 'resize-start') { newStartMin += dMinutes; } 
                else if (interaction.type === 'resize-end' || (interaction.type === 'create-drag' && dy > 0)) { newEndMin += dMinutes; } 
                else if (interaction.type === 'create-drag' && dy < 0) { newStartMin += dMinutes; }
                if (newStartMin > newEndMin) [newStartMin, newEndMin] = [newEndMin, newStartMin];
                if (newEndMin - newStartMin < 30) { if (interaction.type === 'resize-start' || (interaction.type === 'create-drag' && dy <0)) newStartMin = newEndMin - 30; else newEndMin = newStartMin + 30; }
                newStartMin = Math.max(0, newStartMin); newEndMin = Math.min(24 * 60, newEndMin);
                const newBlock = { start: minutesToTime(newStartMin), end: minutesToTime(newEndMin) };
                const otherBookings = Object.values(AppData.entities.bookings).filter(b => b.date === liveBlockState.date && b.blockId !== liveBlockState.blockId);
                let collision = otherBookings.some(b => timeToMinutes(newBlock.start) < timeToMinutes(b.end) && timeToMinutes(newBlock.end) > timeToMinutes(b.start));
                if(!collision) { liveBlockState.start = newBlock.start; liveBlockState.end = newBlock.end; updateSelectedBlockUI(liveBlockState); updateSummaryAndSaveState(liveBlockState); }
            });

            window.addEventListener('mouseup', () => { AppData.ui.modal.interaction = null; });
            
            new ResizeObserver(renderExpandedGraph).observe(DOMElements.expandedGraph);
        }
        
        init();
    </script>
</body>
</html>
