<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orion Infinity Loop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');

        body {
            font-family: 'Heebo', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        /* --- Video Layer --- */
        #video-stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            background: #000;
            pointer-events: none; /* ×××¤×©×¨ ×œ×œ×—×™×¦×•×ª ×œ×¢×‘×•×¨ ×œ×©×›×‘×•×ª ××ª×—×ª ×× ×¦×¨×™×š */
        }

        .player-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out; 
            /* ×”×¤×™×™×“ × ×©×œ×˜ ×¢"×™ JS, ××‘×œ ×–×” ×’×™×‘×•×™ */
        }
        
        .player-wrapper iframe {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* ×–×•× ×¢×“×™×Ÿ ×™×•×ª×¨ ×œ××™×œ×•×™ ××¡×š ×œ×œ× ×©×•×œ×™×™× ×©×—×•×¨×™× */
        .video-foreground {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
        }
        
        @media (min-aspect-ratio: 16/9) {
            .video-foreground iframe { width: 100%; height: 140%; top: -20%; }
        }
        @media (max-aspect-ratio: 16/9) {
            .video-foreground iframe { width: 140%; height: 100%; left: -20%; }
        }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        #ui-layer.hidden-ui {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.05);
        }

        /* --- Floating Toggle Button --- */
        #settings-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 30;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.3s;
        }
        
        /* --- Unmute Overlay --- */
        #unmute-overlay {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            animation: fadeIn 1s ease-out;
            pointer-events: auto;
        }
        
        #unmute-overlay.hidden {
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* --- Playlist Styling --- */
        #playlist-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 120px; 
        }

        .clip-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .clip-item.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.15);
        }

        .clip-row { display: flex; justify-content: space-between; align-items: center; }

        input[type="number"] {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Video Players -->
    <div id="video-stage" onclick="app.unmuteAll()">
        <div id="player1-wrapper" class="player-wrapper video-foreground">
            <div id="player1"></div>
        </div>
        <div id="player2-wrapper" class="player-wrapper video-foreground">
            <div id="player2"></div>
        </div>
    </div>

    <!-- Controls -->
    <div id="settings-toggle" onclick="app.toggleUI()">âš™ï¸</div>

    <div id="unmute-overlay" onclick="app.unmuteAll()">
        <span>ğŸ”‡</span>
        <span class="text-sm font-bold">×œ×—×¥ ×œ×”×¤×¢×œ×ª ×¡××•× ×“</span>
    </div>

    <!-- UI Editor -->
    <div id="ui-layer" class="hidden-ui">
        <div class="p-4 bg-black/50 border-b border-white/10 flex justify-between items-center shrink-0">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-l from-blue-400 to-green-400">×¢×•×¨×š ×”××™×§×¡</h1>
            <button onclick="app.toggleUI()" class="text-2xl">âœ•</button>
        </div>

        <div id="playlist-container"></div>

        <div class="p-4 bg-black border-t border-white/10 text-center shrink-0">
            <div class="flex justify-center gap-4 mb-3">
                <button onclick="app.regeneratePlaylist()" class="bg-blue-600 px-4 py-2 rounded text-sm">ğŸ² ×¢×¨×‘×•×‘ ××—×“×©</button>
                <button onclick="app.addVideoPrompt()" class="bg-gray-700 px-4 py-2 rounded text-sm">+ ×”×•×¡×£ ×•×™×“××•</button>
            </div>
            <div class="text-xs text-gray-500">×”××¢×¨×›×ª ×©×•××¨×ª ×©×™× ×•×™×™× ××•×˜×•××˜×™×ª</div>
        </div>
    </div>

    <script>
        // --- Data ---
        const SOURCE_VIDEOS = [
            { id: 'LvdGbCkZAiY', title: '×× ×™ ×‘×œ ×œ×™', duration: 180 }, 
            { id: 'zUmTkhqFhgw', title: '×’×¨×™× ×˜×™ ×”×“×¡×˜××¨×˜', duration: 120 },
            { id: 'jCVjX_K0swc', title: 'ReLife ×”×“××™×™×”', duration: 60 },
            { id: '1bA6cTw1DJ4', title: '××•×˜×™ ×™×•× ×”×•×œ×“×ª', duration: 40 },
            { id: 'T9vEvAcai_I', title: '×’×¨×™×Ÿ ×¡×§×¨×™×Ÿ', duration: 30 },
            { id: 'WSL1iYAyj4I', title: '×’×‘×¨×™××œ ×¢×˜×™×¤×”', duration: 20 },
            { id: 'NT_4d8sSdls', title: '××¡×£ ××•×¨ ×¢×˜×™×¤×”', duration: 20 },
            { id: 'J1fY6H1cj3A', title: '×©×™×œ×•×˜', duration: 15 },
            { id: 'aydTo0aZRtA', title: '×¨×—×¤×Ÿ ×˜×¨××§×™× ×’', duration: 15 },
            { id: 'p02kAntlIyY', title: '× ×•×¢× ××™×›××œ ×§×œ×™×¤', duration: 180 },
            { id: '_rv2sMdyCpg', title: 'RedBull', duration: 60 }
        ];

        const CROSSFADE_TIME = 1.5;
        
        class LoopApp {
            constructor() {
                this.playlist = JSON.parse(localStorage.getItem('orionMixV3')) || this.createAutoPlaylist();
                this.currentIndex = 0;
                this.isPlaying = false;
                this.activePlayer = 1; 
                this.isMuted = true;
                this.monitorInterval = null;
                this.fadeInterval = null;
                this.nextLoaded = false;
            }

            createAutoPlaylist() {
                let list = [];
                // ×™×¦×™×¨×ª ×¡×œ×™×™×¡×™× ×‘×˜×•×—×” ×™×•×ª×¨
                SOURCE_VIDEOS.forEach(video => {
                    const step = 15; // ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ×œ×’×™×•×•×Ÿ
                    const clipDuration = 5; 
                    for (let t = 0; t < (video.duration || 30) - clipDuration; t += step) {
                        list.push({
                            uuid: crypto.randomUUID(),
                            videoId: video.id,
                            title: video.title,
                            start: t,
                            duration: clipDuration
                        });
                    }
                });
                // ×¢×¨×‘×•×‘
                for (let i = list.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [list[i], list[j]] = [list[j], list[i]];
                }
                return list.length > 0 ? list : this.backupList();
            }
            
            backupList() {
                // ×¨×©×™××ª ×’×™×‘×•×™ ×œ××§×¨×” ×—×™×¨×•×
                return [{ uuid: '1', videoId: 'LvdGbCkZAiY', title: 'Backup', start: 10, duration: 5 }];
            }

            regeneratePlaylist() {
                this.playlist = this.createAutoPlaylist();
                this.currentIndex = 0;
                this.save();
                this.renderList();
            }

            save() { localStorage.setItem('orionMixV3', JSON.stringify(this.playlist)); }

            toggleUI() {
                document.getElementById('ui-layer').classList.toggle('hidden-ui');
            }

            unmuteAll() {
                if (!this.isMuted) return;
                this.isMuted = false;
                
                // Unmute active players
                if(player1 && player1.unMute) player1.unMute();
                if(player2 && player2.unMute) player2.unMute();
                
                document.getElementById('unmute-overlay').classList.add('hidden');
                console.log("Sound Enabled");
            }

            // --- Engine ---

            startEngine() {
                console.log("Starting Engine...");
                this.isPlaying = true;
                this.playSequence(this.currentIndex);
                this.renderList();
            }

            playSequence(index) {
                if (!this.isPlaying) return;
                if (index >= this.playlist.length) index = 0;
                this.currentIndex = index;

                // ×¢×“×›×•×Ÿ UI ×¨×§ ×× ×¤×ª×•×— (×—×•×¡×š ××©××‘×™×)
                if(!document.getElementById('ui-layer').classList.contains('hidden-ui')) {
                    this.renderList();
                }

                const clip = this.playlist[index];
                const currentP = this.activePlayer === 1 ? player1 : player2;
                const nextP = this.activePlayer === 1 ? player2 : player1;
                
                const currentWrapper = this.activePlayer === 1 ? document.getElementById('player1-wrapper') : document.getElementById('player2-wrapper');
                const nextWrapper = this.activePlayer === 1 ? document.getElementById('player2-wrapper') : document.getElementById('player1-wrapper');

                // Load & Play Current (if not already playing from fade)
                if (currentWrapper.style.opacity != '1') {
                    // Force mute initially to allow autoplay
                    if(this.isMuted) currentP.mute();
                    else currentP.unMute();

                    currentP.loadVideoById({videoId: clip.videoId, startSeconds: clip.start});
                    currentP.playVideo(); 
                    
                    // Show immediately
                    currentWrapper.style.opacity = 1;
                    nextWrapper.style.opacity = 0;
                }

                this.nextLoaded = false;
                
                // Monitor Loop
                clearInterval(this.monitorInterval);
                this.monitorInterval = setInterval(() => {
                    if (!this.isPlaying) return;

                    // Safety check if player crashed or ended early
                    const state = currentP.getPlayerState();
                    if(state === 0) { // Ended
                        this.playSequence(this.currentIndex + 1);
                        return;
                    }

                    const currTime = currentP.getCurrentTime();
                    if (!currTime && currTime !== 0) return; // Not ready

                    const played = currTime - clip.start;
                    
                    // ×‘××§×¨×™× ×©×œ ×¡×˜×™×™×” ×‘×–×× ×™× (×œ××©×œ ×¤×¨×¡×•××ª ×‘×™×•×˜×™×•×‘ ×©×©×™×‘×©×” ××ª ×”×˜×™×™××¨)
                    if (played < -2) {
                        // ×›× ×¨××” ×”×ª×—×™×œ ××”×ª×—×œ×” ×‘×˜×¢×•×ª
                        // currentP.seekTo(clip.start);
                    }

                    const remaining = clip.duration - played;

                    // Preload Next (2.5s before end)
                    if (remaining <= 2.5 && !this.nextLoaded) {
                        this.nextLoaded = true;
                        let nextIdx = index + 1;
                        if (nextIdx >= this.playlist.length) nextIdx = 0;
                        const nextClip = this.playlist[nextIdx];
                        
                        nextP.mute(); // Always load background muted first
                        nextP.loadVideoById({
                            videoId: nextClip.videoId,
                            startSeconds: nextClip.start
                        });
                        nextP.playVideo(); // Buffer it
                    }

                    // Crossfade (1.5s before end)
                    if (remaining <= CROSSFADE_TIME) {
                        clearInterval(this.monitorInterval);
                        this.doCrossfade(currentP, currentWrapper, nextP, nextWrapper);
                    }
                }, 200);
            }

            doCrossfade(pOut, wOut, pIn, wIn) {
                const steps = 10;
                const stepTime = (CROSSFADE_TIME * 1000) / steps;
                let step = 0;

                // Ensure pIn is playing
                pIn.playVideo();

                clearInterval(this.fadeInterval);
                this.fadeInterval = setInterval(() => {
                    step++;
                    const progress = step / steps; 

                    wOut.style.opacity = 1 - progress;
                    wIn.style.opacity = progress;

                    // Volume management (only if sound enabled globally)
                    if (!this.isMuted) {
                        pOut.setVolume((1 - progress) * 100);
                        pIn.setVolume(progress * 100);
                        if (progress > 0.1) pIn.unMute();
                    }

                    if (step >= steps) {
                        clearInterval(this.fadeInterval);
                        wOut.style.opacity = 0;
                        pOut.pauseVideo(); // Stop old
                        
                        wIn.style.opacity = 1;
                        if(!this.isMuted) pIn.setVolume(100);

                        this.activePlayer = this.activePlayer === 1 ? 2 : 1;
                        this.playSequence(this.currentIndex + 1);
                    }
                }, stepTime);
            }

            // --- Playlist UI ---
            renderList() {
                const container = document.getElementById('playlist-container');
                container.innerHTML = ''; // Reset

                this.playlist.forEach((clip, idx) => {
                    const el = document.createElement('div');
                    el.className = `clip-item ${idx === this.currentIndex ? 'active' : ''}`;
                    el.innerHTML = `
                        <div class="clip-row">
                            <span class="text-xs font-mono text-gray-500">${idx+1}</span>
                            <span class="truncate text-sm font-bold flex-1 mx-2">${clip.title}</span>
                            <button onclick="app.removeClip(${idx})" class="text-red-500">Ã—</button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }

            removeClip(idx) {
                this.playlist.splice(idx, 1);
                this.save();
                this.renderList();
            }

            addVideoPrompt() {
                const url = prompt("Link:");
                if(url) {
                    let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                    this.playlist.push({uuid:crypto.randomUUID(), videoId:id, title:'New', start:0, duration:5});
                    this.save();
                    this.renderList();
                }
            }
        }

        const app = new LoopApp();

        // --- Setup ---
        let player1, player2;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            const pVars = { 
                controls: 0, showinfo: 0, rel: 0, modestbranding: 1, 
                iv_load_policy: 3, fs: 0, playsinline: 1, disablekb: 1,
                origin: window.location.origin // Crucial for some browsers
            };
            
            player1 = new YT.Player('player1', { height:'100%', width:'100%', playerVars: pVars, events: { 'onReady': onPlayerReady, 'onError': onPlayerError } });
            player2 = new YT.Player('player2', { height:'100%', width:'100%', playerVars: pVars, events: { 'onReady': onPlayerReady, 'onError': onPlayerError } });
        }

        let readyCount = 0;
        function onPlayerReady(e) {
            e.target.mute(); // MUST mute for autoplay
            readyCount++;
            if(readyCount === 2) {
                // Auto Start!
                setTimeout(() => app.startEngine(), 500);
            }
        }

        function onPlayerError(e) {
            console.warn("Video Error:", e.data);
            // If error, skip to next immediately
            app.playSequence(app.currentIndex + 1);
        }

    </script>
</body>
</html>


