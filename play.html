<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orion Infinity Loop V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');

        body {
            font-family: 'Heebo', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        /* --- Video Layer --- */
        #video-stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            background: #000;
            pointer-events: none;
        }

        .player-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out; 
        }
        
        .player-wrapper iframe {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .video-foreground {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
        }
        
        @media (min-aspect-ratio: 16/9) {
            .video-foreground iframe { width: 100%; height: 140%; top: -20%; }
        }
        @media (max-aspect-ratio: 16/9) {
            .video-foreground iframe { width: 140%; height: 100%; left: -20%; }
        }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        #ui-layer.hidden-ui {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.05);
        }

        /* Toggle Button */
        #settings-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 30;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.3s;
        }
        
        /* Unmute Overlay */
        #unmute-overlay {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            animation: fadeIn 1s ease-out;
            pointer-events: auto;
        }
        
        #unmute-overlay.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* Playlist */
        #playlist-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 20px; 
        }

        .clip-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .clip-item.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.15);
        }

        .clip-row { display: flex; justify-content: space-between; align-items: center; }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #222;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        
        .time-input-group label { font-size: 0.7rem; color: #aaa; }
        
        input[type="number"] {
            background: transparent;
            border: none;
            color: white;
            width: 50px;
            text-align: center;
            outline: none;
            font-weight: bold;
        }

        /* Buttons */
        .btn-icon { padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); }
        
        .btn-action {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <!-- Video Stage -->
    <div id="video-stage" onclick="app.unmuteAll()">
        <div id="player1-wrapper" class="player-wrapper video-foreground">
            <div id="player1"></div>
        </div>
        <div id="player2-wrapper" class="player-wrapper video-foreground">
            <div id="player2"></div>
        </div>
    </div>

    <!-- Floating Controls -->
    <div id="settings-toggle" onclick="app.toggleUI()">âš™ï¸</div>

    <div id="unmute-overlay" onclick="app.unmuteAll()">
        <span>ğŸ”‡</span>
        <span class="text-sm font-bold">×œ×—×¥ ×œ×”×¤×¢×œ×ª ×¡××•× ×“</span>
    </div>

    <!-- Editor UI -->
    <div id="ui-layer" class="hidden-ui">
        <div class="p-4 bg-black/50 border-b border-white/10 flex justify-between items-center shrink-0">
            <h1 class="text-lg font-bold text-green-400">×¢×•×¨×š ×”××™×§×¡</h1>
            <div class="flex gap-2">
                <button onclick="app.downloadJSON()" class="text-xs bg-blue-900/50 border border-blue-500/50 px-2 py-1 rounded hover:bg-blue-800">â¬‡ ×©××•×¨ JSON</button>
                <button onclick="document.getElementById('file-input').click()" class="text-xs bg-purple-900/50 border border-purple-500/50 px-2 py-1 rounded hover:bg-purple-800">â¬† ×˜×¢×Ÿ JSON</button>
                <input type="file" id="file-input" accept=".json" style="display: none" onchange="app.uploadJSON(this)">
                <button onclick="app.toggleUI()" class="text-xl ml-2 text-gray-400">âœ•</button>
            </div>
        </div>

        <div id="playlist-container"></div>

        <div class="p-4 bg-black border-t border-white/10 shrink-0 space-y-3">
            <div class="flex gap-3">
                <button onclick="app.regeneratePlaylist()" class="btn-action bg-red-900/40 text-red-200 border border-red-500/30">
                    ğŸ² ×¢×¨×‘×•×‘ ××—×“×© (××—×™×§×”)
                </button>
                <button onclick="app.addVideoPrompt()" class="btn-action bg-gray-700 text-white hover:bg-gray-600">
                    + ×”×•×¡×£ ×œ×™× ×§
                </button>
            </div>
            <div class="text-[10px] text-gray-500 text-center">
                ×”×©×™× ×•×™×™× × ×©××¨×™× ××•×˜×•××˜×™×ª ×‘××›×©×™×¨ ×–×”. ×”×•×¨×“ JSON ×œ×’×™×‘×•×™ ×—×™×¦×•× ×™.
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const SOURCE_VIDEOS = [
            { id: 'LvdGbCkZAiY', title: '×× ×™ ×‘×œ ×œ×™', duration: 180 }, 
            { id: 'zUmTkhqFhgw', title: '×’×¨×™× ×˜×™ ×”×“×¡×˜××¨×˜', duration: 120 },
            { id: 'jCVjX_K0swc', title: 'ReLife ×”×“××™×™×”', duration: 60 },
            { id: '1bA6cTw1DJ4', title: '××•×˜×™ ×™×•× ×”×•×œ×“×ª', duration: 40 },
            { id: 'T9vEvAcai_I', title: '×’×¨×™×Ÿ ×¡×§×¨×™×Ÿ', duration: 30 },
            { id: 'WSL1iYAyj4I', title: '×’×‘×¨×™××œ ×¢×˜×™×¤×”', duration: 20 },
            { id: 'NT_4d8sSdls', title: '××¡×£ ××•×¨ ×¢×˜×™×¤×”', duration: 20 },
            { id: 'J1fY6H1cj3A', title: '×©×™×œ×•×˜', duration: 15 },
            { id: 'aydTo0aZRtA', title: '×¨×—×¤×Ÿ ×˜×¨××§×™× ×’', duration: 15 },
            { id: 'p02kAntlIyY', title: '× ×•×¢× ××™×›××œ ×§×œ×™×¤', duration: 180 },
            { id: '_rv2sMdyCpg', title: 'RedBull', duration: 60 }
        ];

        const CROSSFADE_TIME = 1.5;
        
        class LoopApp {
            constructor() {
                // ×‘×“×™×§×ª ×–×™×›×¨×•×Ÿ ××§×•××™
                const saved = localStorage.getItem('orionMixV4');
                
                if (saved) {
                    try {
                        this.playlist = JSON.parse(saved);
                        console.log("Loaded saved playlist");
                    } catch(e) {
                        console.error("Save file corrupted, creating new");
                        this.playlist = this.createAutoPlaylist();
                    }
                } else {
                    console.log("No save found, generating random");
                    this.playlist = this.createAutoPlaylist();
                }

                this.currentIndex = 0;
                this.isPlaying = false;
                this.activePlayer = 1; 
                this.isMuted = true;
                this.monitorInterval = null;
                this.fadeInterval = null;
                this.nextLoaded = false;
            }

            createAutoPlaylist() {
                let list = [];
                SOURCE_VIDEOS.forEach(video => {
                    const step = 15; 
                    const clipDuration = 5; 
                    for (let t = 0; t < (video.duration || 30) - clipDuration; t += step) {
                        list.push({
                            uuid: crypto.randomUUID(),
                            videoId: video.id,
                            title: video.title,
                            start: t,
                            duration: clipDuration
                        });
                    }
                });
                for (let i = list.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [list[i], list[j]] = [list[j], list[i]];
                }
                return list.length > 0 ? list : this.backupList();
            }
            
            backupList() {
                return [{ uuid: '1', videoId: 'LvdGbCkZAiY', title: 'Backup', start: 10, duration: 5 }];
            }

            regeneratePlaylist() {
                if(confirm("×–×” ×™××—×§ ××ª ×”×¨×©×™××” ×”× ×•×›×—×™×ª ×•×™×™×¦×•×¨ ×¨×©×™××” ××§×¨××™×ª ×—×“×©×”. ×œ×”××©×™×š?")) {
                    this.playlist = this.createAutoPlaylist();
                    this.currentIndex = 0;
                    this.save();
                    this.renderList();
                }
            }

            // --- Persistence & JSON ---

            save() { 
                localStorage.setItem('orionMixV4', JSON.stringify(this.playlist)); 
            }

            downloadJSON() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.playlist, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                const date = new Date().toISOString().slice(0,10);
                downloadAnchorNode.setAttribute("download", `orion_mix_${date}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            uploadJSON(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            this.playlist = json;
                            this.save();
                            this.renderList();
                            alert("×”×¨×©×™××” × ×˜×¢× ×” ×‘×”×¦×œ×—×”!");
                        } else {
                            alert("××‘× ×” ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
                        }
                    } catch (err) {
                        alert("×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥");
                    }
                };
                reader.readAsText(file);
                // Reset input
                input.value = '';
            }

            // --- UI Interaction ---

            toggleUI() {
                document.getElementById('ui-layer').classList.toggle('hidden-ui');
            }

            unmuteAll() {
                if (!this.isMuted) return;
                this.isMuted = false;
                if(player1 && player1.unMute) player1.unMute();
                if(player2 && player2.unMute) player2.unMute();
                document.getElementById('unmute-overlay').classList.add('hidden');
            }

            // --- Actions ---

            duplicateClip(idx) {
                const original = this.playlist[idx];
                const copy = {
                    ...original,
                    uuid: crypto.randomUUID(),
                    title: original.title + ' (×”×¢×ª×§)'
                };
                // Insert after current
                this.playlist.splice(idx + 1, 0, copy);
                this.save();
                this.renderList();
            }

            updateTimes(idx, type, val) {
                const clip = this.playlist[idx];
                const value = parseFloat(val);
                
                if (type === 'start') {
                    // Changing start time, preserve duration logic for UI (Start + Duration = End)
                    // If user changes Start from 10 to 12, Duration remains 5, so End becomes 17.
                    clip.start = value;
                } else if (type === 'end') {
                    // Changing end time updates duration
                    // Start 10, End 15 -> Duration 5.
                    // If User sets End 20 -> Duration 10.
                    if (value > clip.start) {
                        clip.duration = value - clip.start;
                    }
                }
                this.save();
            }

            removeClip(idx) {
                if(this.playlist.length <= 1) return;
                this.playlist.splice(idx, 1);
                this.save();
                this.renderList();
            }

            addVideoPrompt() {
                const url = prompt("Link:");
                if(url) {
                    let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                    this.playlist.push({uuid:crypto.randomUUID(), videoId:id, title:'New Clip', start:0, duration:5});
                    this.save();
                    this.renderList();
                }
            }

            // --- Render ---

            renderList() {
                const container = document.getElementById('playlist-container');
                container.innerHTML = ''; 

                this.playlist.forEach((clip, idx) => {
                    const isActive = idx === this.currentIndex;
                    const endTime = clip.start + clip.duration;
                    
                    const el = document.createElement('div');
                    el.className = `clip-item ${isActive ? 'active' : ''}`;
                    el.innerHTML = `
                        <div class="clip-row">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <span class="text-xs font-mono text-gray-500 w-5">${idx+1}</span>
                                <span class="truncate text-sm font-bold max-w-[150px] ${isActive ? 'text-green-300' : 'text-gray-300'}">${clip.title}</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="app.duplicateClip(${idx})" class="btn-icon text-blue-400" title="×©×›×¤×œ">ğŸ“„</button>
                                <button onclick="app.removeClip(${idx})" class="btn-icon text-red-500" title="××—×§">âœ•</button>
                            </div>
                        </div>
                        
                        <div class="clip-row mt-2">
                             <div class="time-input-group">
                                <label>IN</label>
                                <input type="number" step="0.1" value="${clip.start.toFixed(1)}" onchange="app.updateTimes(${idx}, 'start', this.value)">
                            </div>
                            <div class="h-[1px] bg-gray-600 w-4"></div>
                            <div class="time-input-group">
                                <label>OUT</label>
                                <input type="number" step="0.1" value="${endTime.toFixed(1)}" onchange="app.updateTimes(${idx}, 'end', this.value)">
                            </div>
                            <span class="text-[10px] text-gray-500 ml-2">(${clip.duration.toFixed(1)}s)</span>
                        </div>
                    `;
                    container.appendChild(el);
                    
                    if(isActive && !document.getElementById('ui-layer').classList.contains('hidden-ui')) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            // --- Engine ---

            startEngine() {
                this.isPlaying = true;
                this.playSequence(this.currentIndex);
                this.renderList();
            }

            playSequence(index) {
                if (!this.isPlaying) return;
                if (index >= this.playlist.length) index = 0;
                this.currentIndex = index;

                // UI update (only if visible logic handled in render)
                if(!document.getElementById('ui-layer').classList.contains('hidden-ui')) {
                    this.renderList();
                }

                const clip = this.playlist[index];
                const currentP = this.activePlayer === 1 ? player1 : player2;
                const nextP = this.activePlayer === 1 ? player2 : player1;
                
                const currentWrapper = this.activePlayer === 1 ? document.getElementById('player1-wrapper') : document.getElementById('player2-wrapper');
                const nextWrapper = this.activePlayer === 1 ? document.getElementById('player2-wrapper') : document.getElementById('player1-wrapper');

                if (currentWrapper.style.opacity != '1') {
                    if(this.isMuted) currentP.mute();
                    else currentP.unMute();
                    currentP.loadVideoById({videoId: clip.videoId, startSeconds: clip.start});
                    currentP.playVideo(); 
                    currentWrapper.style.opacity = 1;
                    nextWrapper.style.opacity = 0;
                }

                this.nextLoaded = false;
                
                clearInterval(this.monitorInterval);
                this.monitorInterval = setInterval(() => {
                    if (!this.isPlaying) return;

                    const state = currentP.getPlayerState();
                    if(state === 0) { 
                        this.playSequence(this.currentIndex + 1);
                        return;
                    }

                    const currTime = currentP.getCurrentTime();
                    if (!currTime && currTime !== 0) return; 

                    const played = currTime - clip.start;
                    if (played < -2) {} // Seek correction placeholder

                    const remaining = clip.duration - played;

                    // Preload
                    if (remaining <= 2.5 && !this.nextLoaded) {
                        this.nextLoaded = true;
                        let nextIdx = index + 1;
                        if (nextIdx >= this.playlist.length) nextIdx = 0;
                        const nextClip = this.playlist[nextIdx];
                        
                        nextP.mute(); 
                        nextP.loadVideoById({ videoId: nextClip.videoId, startSeconds: nextClip.start });
                        nextP.playVideo(); 
                    }

                    // Crossfade
                    if (remaining <= CROSSFADE_TIME) {
                        clearInterval(this.monitorInterval);
                        this.doCrossfade(currentP, currentWrapper, nextP, nextWrapper);
                    }
                }, 200);
            }

            doCrossfade(pOut, wOut, pIn, wIn) {
                const steps = 10;
                const stepTime = (CROSSFADE_TIME * 1000) / steps;
                let step = 0;
                pIn.playVideo();

                clearInterval(this.fadeInterval);
                this.fadeInterval = setInterval(() => {
                    step++;
                    const progress = step / steps; 

                    wOut.style.opacity = 1 - progress;
                    wIn.style.opacity = progress;

                    if (!this.isMuted) {
                        pOut.setVolume((1 - progress) * 100);
                        pIn.setVolume(progress * 100);
                        if (progress > 0.1) pIn.unMute();
                    }

                    if (step >= steps) {
                        clearInterval(this.fadeInterval);
                        wOut.style.opacity = 0;
                        pOut.pauseVideo();
                        
                        wIn.style.opacity = 1;
                        if(!this.isMuted) pIn.setVolume(100);

                        this.activePlayer = this.activePlayer === 1 ? 2 : 1;
                        this.playSequence(this.currentIndex + 1);
                    }
                }, stepTime);
            }
        }

        const app = new LoopApp();

        let player1, player2;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            const pVars = { 
                controls: 0, showinfo: 0, rel: 0, modestbranding: 1, 
                iv_load_policy: 3, fs: 0, playsinline: 1, disablekb: 1,
                origin: window.location.origin
            };
            player1 = new YT.Player('player1', { height:'100%', width:'100%', playerVars: pVars, events: { 'onReady': onPlayerReady, 'onError': onPlayerError } });
            player2 = new YT.Player('player2', { height:'100%', width:'100%', playerVars: pVars, events: { 'onReady': onPlayerReady, 'onError': onPlayerError } });
        }

        let readyCount = 0;
        function onPlayerReady(e) {
            e.target.mute(); 
            readyCount++;
            if(readyCount === 2) {
                setTimeout(() => app.startEngine(), 500);
            }
        }

        function onPlayerError(e) {
            console.warn("Video Error:", e.data);
            app.playSequence(app.currentIndex + 1);
        }

    </script>
</body>
</html>


