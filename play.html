<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity V14 - Varied</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');

        body {
            font-family: 'Heebo', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            margin: 0; padding: 0;
            touch-action: manipulation;
        }

        /* --- Background Video Mixers --- */
        #video-stage {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0; background: #000; pointer-events: none;
        }
        .player-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transition: opacity 0.5s ease-in-out; 
        }
        .video-foreground { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Zoom Fix */
        @media (min-aspect-ratio: 16/9) { .video-foreground iframe { width: 100%; height: 140%; top: -20%; } }
        @media (max-aspect-ratio: 16/9) { .video-foreground iframe { width: 140%; height: 100%; left: -20%; } }
        .player-wrapper iframe { width: 100%; height: 100%; pointer-events: none; }

        /* --- UI Overlay --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex; flex-direction: column;
        }
        #ui-layer.hidden-ui { opacity: 0; pointer-events: none; transform: scale(1.05); }

        /* --- Floating Info --- */
        #floating-info {
            position: fixed; top: 20px; left: 20px; z-index: 10;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 15px; border-radius: 12px;
            max-width: 200px; cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(-100px); opacity: 0;
        }
        #floating-info.visible { transform: translateY(0); opacity: 1; }
        .float-title { font-size: 0.8rem; font-weight: bold; color: white; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .float-brand { font-size: 0.7rem; color: #4ade80; margin-top: 2px; }

        /* --- Tabs --- */
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #333; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; color: #888; font-weight: bold; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #fff; border-bottom-color: #4ade80; background: #1a1a1a; }
        #tab-content-area { flex: 1; overflow-y: auto; padding: 15px; }
        .view-section { display: none; } .view-section.active { display: block; }

        /* --- Items --- */
        .clip-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; margin-bottom: 8px; padding: 10px; display: flex; align-items: center; gap: 12px; }
        .clip-card.playing { border-color: #4ade80; background: #152515; }
        .clip-info { flex: 1; overflow: hidden; cursor: pointer; }
        .clip-title { font-weight: bold; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-timeline { height: 3px; background: #333; border-radius: 2px; margin-top: 6px; position: relative; width: 100%; }
        .mini-range { position: absolute; height: 100%; background: #4ade80; border-radius: 2px; }
        
        /* --- Source Group --- */
        .source-group { margin-bottom: 20px; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .source-header { background: #222; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .source-title { font-weight: bold; font-size: 0.9rem; color: #ddd; }
        .source-clips { padding: 5px; background: #111; }
        .source-clip-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; font-size: 0.8rem; color: #aaa; }

        /* --- Editor --- */
        #editor-modal { position: fixed; inset: 0; z-index: 50; background: #111; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s; }
        #editor-modal.open { transform: translateY(0); }
        #editor-player-container { width: 100%; aspect-ratio: 16/9; background: #000; flex-shrink: 0; position: relative; }
        .editor-controls { padding: 20px; flex: 1; overflow-y: auto; }
        .timeline-wrapper { position: relative; height: 60px; display: flex; align-items: center; touch-action: none; margin: 0 10px; }
        .timeline-track { position: absolute; left: 0; right: 0; height: 12px; background: #222; border-radius: 6px; border: 1px solid #333; }
        .timeline-range { position: absolute; height: 12px; background: rgba(74, 222, 128, 0.3); border-radius: 2px; border-top: 1px solid #4ade80; border-bottom: 1px solid #4ade80; }
        .timeline-handle { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 30px; height: 50px; z-index: 10; cursor: col-resize; display: flex; justify-content: center; align-items: center; }
        .timeline-handle::after { content: ''; display: block; width: 4px; height: 40px; border-radius: 2px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .handle-l::after { background: #4ade80; } .handle-r::after { background: #ef4444; }
        .playhead { position: absolute; top: 10px; bottom: 10px; width: 2px; background: #fff; pointer-events: none; z-index: 5; opacity: 0.8; }

        /* Controls */
        #settings-toggle { position: fixed; top: 20px; right: 20px; z-index: 30; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; backdrop-filter: blur(4px); cursor: pointer; }
        #unmute-overlay { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 25; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; animation: fadeIn 1s ease-out; cursor: pointer;}
        #unmute-overlay.hidden { display: none; }
        
        /* Details View */
        .tag { display: inline-block; background: #222; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: #ccc; margin: 2px; }
        .tag.brand { border-color: #4ade80; color: #4ade80; }
        .highlight-item { padding: 10px; border-bottom: 1px solid #222; display: flex; gap: 10px; align-items: center; cursor: pointer; }

    </style>
</head>
<body>

    <!-- Background Mixers -->
    <div id="video-stage">
        <div id="player1-wrapper" class="player-wrapper video-foreground"><div id="player1"></div></div>
        <div id="player2-wrapper" class="player-wrapper video-foreground"><div id="player2"></div></div>
    </div>

    <!-- Floating Info -->
    <div id="floating-info" onclick="app.openDetailsTab()">
        <div class="float-title" id="float-title">Title</div>
        <div class="float-brand" id="float-brand">Brand</div>
        <div class="text-[10px] text-gray-400 mt-1">×œ×—×¥ ×œ×¤×¨×˜×™×</div>
    </div>

    <!-- Controls -->
    <div id="settings-toggle" onclick="app.toggleUI()">âš™ï¸</div>
    <div id="unmute-overlay" onclick="app.unmuteAll()">
        <span>ğŸ”‡</span><span class="text-sm font-bold">×”×¤×¢×œ ×¡××•× ×“</span>
    </div>

    <!-- Main UI -->
    <div id="ui-layer" class="hidden-ui">
        <div class="p-3 bg-black/50 border-b border-white/10 flex justify-between items-center shrink-0">
            <h1 class="text-lg font-bold text-green-400">Mixer V14</h1>
            <button onclick="app.toggleUI()" class="text-xl text-gray-400">âœ•</button>
        </div>

        <div class="p-2 bg-black">
            <input type="text" placeholder="×—×¤×© ×œ×¤×™ ×˜×›× ×™×§×”, ××•×‘×™×™×§×˜..." class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm" oninput="app.handleSearch(this.value)">
        </div>

        <div class="tab-bar">
            <div class="tab-btn active" onclick="app.switchTab('sequence')">×¡×™×§×•×•× ×¡</div>
            <div class="tab-btn" onclick="app.switchTab('sources')">××§×•×¨×•×ª</div>
            <div class="tab-btn" onclick="app.switchTab('details')">×¤×¨×˜×™×</div>
        </div>

        <div id="tab-content-area">
            <div id="view-sequence" class="view-section active">
                <div id="playlist-container"></div>
                <div class="text-center p-4"><button onclick="app.regeneratePlaylist()" class="text-red-400 text-sm">×¢×¨×‘×•×‘ ××—×“×©</button></div>
            </div>
            <div id="view-sources" class="view-section"><div id="sources-container"></div></div>
            <div id="view-details" class="view-section"><div id="details-content" class="p-4 text-center text-gray-500">× ×’×Ÿ ×¡×¨×˜×•×Ÿ ×œ×¤×¨×˜×™×</div></div>
        </div>
    </div>

    <!-- Editor -->
    <div id="editor-modal">
        <div class="flex justify-between items-center p-4 bg-black border-b border-white/10">
            <h2 class="text-sm font-bold">×¢×¨×™×›×” (××§×¡' 15 ×©× ×™×•×ª)</h2>
            <button onclick="editor.close()" class="bg-gray-800 px-3 py-1 rounded text-xs">×¡×’×•×¨</button>
        </div>
        <div id="editor-player-container"><div id="editor-player"></div></div>
        <div class="editor-controls">
            <div class="flex justify-center gap-4 items-center mb-4">
                <button onclick="editor.togglePlay()" class="text-2xl">â–¶/â¸</button>
                <div id="editor-time-display" class="font-mono text-blue-400">00:00</div>
            </div>
            <div class="px-2 mb-6">
                <div class="flex justify-between text-xs text-gray-500 mb-6">
                    <span id="label-in">IN</span><span id="label-out">OUT</span>
                </div>
                <div class="timeline-wrapper" id="timeline-track-area">
                    <div class="timeline-track"></div><div class="timeline-range" id="timeline-fill"></div>
                    <div class="playhead" id="editor-playhead"></div>
                    <div class="timeline-handle handle-l" id="handle-in"></div>
                    <div class="timeline-handle handle-r" id="handle-out"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="editor.duplicateClip()" class="bg-blue-900/30 p-2 rounded text-sm">×©×›×¤×œ</button>
                <button onclick="editor.deleteClip()" class="bg-red-900/30 p-2 rounded text-sm">××—×§</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA UPDATED FOR VFX/AFTER EFFECTS CONTEXT ---
        const VIDEO_DATABASE = [
            { 
                id: 'LvdGbCkZAiY', 
                title: "×§×œ×™×¤ ××•×–×™×§×œ×™ - ×©×™×œ×•×‘ AI", 
                brand: "AI Generation", 
                concept: "×™×¦×™×¨×ª ×ª×•×›×Ÿ ×’× ×¨×˜×™×‘×™", 
                objects: ["×“××•×™×•×ª AI", "×¨×§×¢×™× ××©×ª× ×™×", "Interpolation", "Glitch"], 
                duration: 180, 
                highlights: [
                    {start:0, desc:"Intro: ×™×¦×™×¨×ª ×“××•×™×•×ª ×‘-AI"}, 
                    {start:19, desc:"Morphing ×‘×™×Ÿ ×¡×’× ×•× ×•×ª"}
                ] 
            },
            { 
                id: 'zUmTkhqFhgw', 
                title: "×¡×¨×˜×•×Ÿ ×”×¡×‘×¨×” - GreenTea", 
                brand: "Motion Graphics", 
                concept: "××™× ×¤×•×’×¨×¤×™×§×” ×•×”× ×¤×©×”", 
                objects: ["Shape Layers", "××™×™×§×•× ×™×", "×˜×§×¡×˜ ×§×™× ×˜×™", "Transitions"], 
                duration: 120, 
                highlights: [
                    {start:3, desc:"×”× ×¤×©×ª ×œ×•×’×• ×•×›×•×ª×¨×ª"}, 
                    {start:10, desc:"×ª×¨×©×™× ×–×¨×™××” ××•× ×¤×©"}
                ] 
            },
            { 
                id: '1bA6cTw1DJ4', 
                title: "×‘×¨×›×” ××•× ×¤×©×ª - ××•×˜×™", 
                brand: "Character Animation", 
                concept: "Cut-out / Duik", 
                objects: ["×¨×™×’ ×“××•×ª", "Puppet Tool", "×¨×§×¢ ×•×§×˜×•×¨×™", "×‘×œ×•× ×™ ×“×™×‘×•×¨"], 
                duration: 60, 
                highlights: [
                    {start:0, desc:"×›× ×™×¡×ª ×“××•×ª (Walk Cycle)"}
                ] 
            },
            { 
                id: 'T9vEvAcai_I', 
                title: "×§×•××¤×•×–×™×¦×™×” - ×¨×—×¤×Ÿ ×™×", 
                brand: "VFX / Compositing", 
                concept: "×”×˜××¢×” (Embedding)", 
                objects: ["Chroma Key", "×”×©×ª×§×¤×•×™×•×ª", "×©×›×‘×ª ×™×", "Color Match"], 
                duration: 60, 
                highlights: [
                    {start:0, desc:"×œ×¤× ×™/××—×¨×™ Keying"},
                    {start:5, desc:"×©×™×œ×•×‘ ×¨×§×¢ ××œ××›×•×ª×™"}
                ] 
            },
            { 
                id: 'WSL1iYAyj4I', 
                title: "×”× ×¤×©×ª ×¢×˜×™×¤×” - ×’×‘×¨×™××œ", 
                brand: "2.5D Parallax", 
                concept: "×”×™× ×“×•×¡ ×•×™×–×•××œ×™", 
                objects: ["×”×¤×¨×“×ª ×©×›×‘×•×ª", "Camera 3D", "×—×œ×§×™×§×™× (Particles)", "××•×•×™×¨×”"], 
                duration: 180, 
                highlights: [
                    {start:9, desc:"×ª× ×•×¢×ª ××¦×œ××” (Parallax)"}
                ] 
            },
            { 
                id: 'J1fY6H1cj3A', 
                title: "×”×—×œ×¤×ª ×©×œ×˜×™× - ×›×‘×™×©", 
                brand: "VFX / Tracking", 
                concept: "×”×—×œ×¤×ª ×¤×¨×™×˜×™×", 
                objects: ["Planar Tracking", "Mocha", "Corner Pin", "×”×¡×¨×ª ××•×‘×™×™×§×˜×™×"], 
                duration: 30, 
                highlights: [
                    {start:0, desc:"×¢×§×™×‘×ª ××©×˜×— (Surface)"},
                    {start:2, desc:"×”×—×œ×¤×ª ×ª×•×›×Ÿ ×”×©×œ×˜"}
                ] 
            },
            { 
                id: 'aydTo0aZRtA', 
                title: "×˜×¨××§×™× ×’ ×¨×—×¤×Ÿ - HUD", 
                brand: "3D Tracking", 
                concept: "×××©×§ ×¢×ª×™×“× ×™ (UI)", 
                objects: ["3D Camera Tracker", "Null Objects", "×˜×§×¡×˜ ×¦×£", "HUD Elements"], 
                duration: 70, 
                highlights: [
                    {start:21, desc:"×”×¦××“×ª ×˜×§×¡×˜ ×œ×§×¨×§×¢"}
                ] 
            },
            { 
                id: 'p02kAntlIyY', 
                title: "×§×œ×™×¤ ××™×œ×™× - × ×•×¢×", 
                brand: "Kinetic Typography", 
                concept: "×˜×™×¤×•×’×¨×¤×™×”", 
                objects: ["Text Animators", "×¡×™× ×›×¨×•×Ÿ ××•×“×™×•", "××¦×œ××” ×•×™×¨×˜×•××œ×™×ª", "Easin"], 
                duration: 180, 
                highlights: [
                    {start:33, desc:"×”× ×¤×©×ª ×˜×§×¡×˜ ×œ×¤×™ ×§×¦×‘"}
                ] 
            },
            { 
                id: 'NT_4d8sSdls', 
                title: "×”× ×¤×©×ª ×¢×˜×™×¤×” - ××¡×£", 
                brand: "Atmosphere Loop", 
                concept: "Cinemagraph", 
                objects: ["Masking", "Saber Effect", "×¢×©×Ÿ/×¢×¨×¤×œ", "Color Grading"], 
                duration: 40, 
                highlights: [
                    {start:5, desc:"×œ×•×¤ ×ª× ×•×¢×” ×¢×“×™×Ÿ"}
                ] 
            },
            { 
                id: 'jCVjX_K0swc', 
                title: "×”×“××™×™×ª ××•×¦×¨ - ReLife", 
                brand: "3D Integration", 
                concept: "×”×“××™×™×” ×˜×›× ×™×ª", 
                objects: ["××•×“×œ ×ª×œ×ª-×××“", "Callouts", "Alpha Channel", "×§×•××¤×•×–×™×¦×™×”"], 
                duration: 60, 
                highlights: [
                    {start:0, desc:"×¡×™×‘×•×‘ ××•×¦×¨ ×•×˜×§×¡×˜ ×¦×£"}
                ] 
            }
        ];

        class LoopApp {
            constructor() {
                this.playlist = this.loadPlaylist();
                this.currentIndex = 0;
                this.isPlaying = false;
                this.activePlayer = 1;
                this.monitorInterval = null;
                this.fadeInterval = null;
                this.nextLoaded = false;
                this.currentTab = 'sequence';
                this.searchQuery = '';
                this.stuckCounter = 0;
                this.lastTime = -1;
            }

            loadPlaylist() {
                const saved = localStorage.getItem('orionMixV14');
                return saved ? JSON.parse(saved) : this.createAutoPlaylist();
            }

            createAutoPlaylist() {
                let list = [];
                VIDEO_DATABASE.forEach(v => {
                    const safeTotalDur = (v.duration || 30);
                    if (safeTotalDur <= 15) {
                        list.push({
                            uuid: crypto.randomUUID(),
                            videoId: v.id,
                            title: v.title,
                            brand: v.brand,
                            start: 0,
                            duration: Math.max(3, safeTotalDur - 1.5), 
                            totalDuration: safeTotalDur
                        });
                    } else {
                        // Dynamic segmentation
                        let t = 0;
                        while(t < safeTotalDur - 10) {
                            // Random duration 6-12s
                            let dur = Math.floor(Math.random() * 7) + 6; 
                            
                            // Check boundary
                            if (t + dur > safeTotalDur - 1) {
                                dur = safeTotalDur - 1 - t;
                            }

                            if (dur >= 4) {
                                list.push({ 
                                    uuid: crypto.randomUUID(), 
                                    videoId: v.id, 
                                    title: v.title, 
                                    brand: v.brand, 
                                    start: t, 
                                    duration: dur, 
                                    totalDuration: safeTotalDur 
                                });
                            }
                            
                            // Varied Jump: 15-35s
                            t += dur + Math.floor(Math.random() * 20) + 15;
                        }
                    }
                });
                return list.sort(() => Math.random() - 0.5);
            }

            save() { localStorage.setItem('orionMixV14', JSON.stringify(this.playlist)); }

            autoStart() {
                this.isPlaying = true;
                this.playSequence(this.currentIndex);
                this.renderUI();
            }

            playSequence(index) {
                if (!this.isPlaying) return;
                if (index >= this.playlist.length) index = 0;
                this.currentIndex = index;
                this.updateFloatingCard(this.playlist[index]);

                if(!editor.isOpen) {
                    if(this.currentTab === 'sequence') this.renderSequence();
                    if(this.currentTab === 'details') this.renderUI();
                    this._playInternal(index);
                }
            }

            _playInternal(index) {
                const clip = this.playlist[index];
                const activeP = this.activePlayer === 1 ? player1 : player2;
                const nextP = this.activePlayer === 1 ? player2 : player1;
                const activeW = this.activePlayer === 1 ? document.getElementById('player1-wrapper') : document.getElementById('player2-wrapper');
                const nextW = this.activePlayer === 1 ? document.getElementById('player2-wrapper') : document.getElementById('player1-wrapper');

                if (activeW.style.opacity != '1') {
                    activeP.loadVideoById({videoId: clip.videoId, startSeconds: clip.start});
                    activeP.playVideo();
                    activeW.style.opacity = 1; nextW.style.opacity = 0;
                }

                this.nextLoaded = false;
                this.stuckCounter = 0;
                this.lastTime = -1;

                clearInterval(this.monitorInterval);
                this.monitorInterval = setInterval(() => {
                    if(editor.isOpen) { activeP.pauseVideo(); return; }
                    
                    if(activeP.getPlayerState() === 2) activeP.playVideo();
                    if(activeP.getPlayerState() === YT.PlayerState.ENDED) { this.forceNext(); return; }

                    const t = activeP.getCurrentTime();
                    if (t === this.lastTime) {
                        this.stuckCounter++;
                        if (this.stuckCounter > 8) { this.forceNext(); return; }
                    } else {
                        this.stuckCounter = 0; this.lastTime = t;
                    }

                    if(typeof t !== 'number') return;

                    const realTotal = clip.totalDuration || 1000;
                    if (t >= realTotal - 1.0) { this.forceNext(); return; }

                    const played = t - clip.start;
                    const remaining = clip.duration - played;

                    if(remaining < -0.5) { this.forceNext(); return; }

                    if(remaining <= 3 && !this.nextLoaded) {
                        this.nextLoaded = true;
                        let nextClip = this.playlist[this.currentIndex + 1] || this.playlist[0];
                        nextP.mute();
                        nextP.loadVideoById({videoId: nextClip.videoId, startSeconds: nextClip.start});
                        nextP.playVideo();
                    }

                    if(remaining <= 1.5) {
                        clearInterval(this.monitorInterval);
                        this.doCrossfade(activeP, activeW, nextP, nextW);
                    }
                }, 250);
            }

            doCrossfade(pOut, wOut, pIn, wIn) {
                let step = 0; pIn.playVideo();
                clearInterval(this.fadeInterval);
                this.fadeInterval = setInterval(() => {
                    step++;
                    const p = step / 10;
                    wOut.style.opacity = 1 - p; wIn.style.opacity = p;
                    if(step >= 10) {
                        clearInterval(this.fadeInterval);
                        wOut.style.opacity = 0; pOut.pauseVideo();
                        wIn.style.opacity = 1; pIn.setVolume(100);
                        this.activePlayer = this.activePlayer === 1 ? 2 : 1;
                        this.playSequence(this.currentIndex + 1);
                    }
                }, 150);
            }
            
            forceNext() { 
                clearInterval(this.monitorInterval);
                const activeW = this.activePlayer === 1 ? document.getElementById('player1-wrapper') : document.getElementById('player2-wrapper');
                const nextW = this.activePlayer === 1 ? document.getElementById('player2-wrapper') : document.getElementById('player1-wrapper');
                activeW.style.opacity = 0; nextW.style.opacity = 1;
                this.activePlayer = this.activePlayer === 1 ? 2 : 1;
                this.playSequence(this.currentIndex + 1); 
            }

            toggleUI() { document.getElementById('ui-layer').classList.toggle('hidden-ui'); this.renderUI(); }
            switchTab(t) { 
                this.currentTab = t; 
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                const map = {sequence:0, sources:1, details:2};
                document.querySelectorAll('.tab-btn')[map[t]].classList.add('active');
                document.getElementById('view-'+t).classList.add('active');
                this.renderUI();
            }
            openDetailsTab() {
                document.getElementById('ui-layer').classList.remove('hidden-ui');
                this.switchTab('details');
            }
            updateFloatingCard(clip) {
                const el = document.getElementById('floating-info');
                if(editor.isOpen) el.classList.remove('visible');
                else el.classList.add('visible');
                document.getElementById('float-title').innerText = clip.title;
                document.getElementById('float-brand').innerText = clip.brand || '';
            }
            handleSearch(v) { this.searchQuery = v.toLowerCase(); if(this.currentTab === 'sources') this.renderSources(); }
            
            renderUI() {
                if(this.currentTab==='sequence') this.renderSequence();
                if(this.currentTab==='sources') this.renderSources();
                if(this.currentTab==='details') this.renderDetails();
            }

            renderSequence() {
                const c = document.getElementById('playlist-container'); c.innerHTML = '';
                this.playlist.forEach((clip, i) => {
                    const el = document.createElement('div');
                    el.className = `clip-card ${i===this.currentIndex ? 'playing' : ''}`;
                    const p = (clip.start / (clip.totalDuration||100))*100;
                    const w = (clip.duration / (clip.totalDuration||100))*100;
                    el.innerHTML = `
                        <div class="text-xs text-gray-500 w-6">#${i+1}</div>
                        <div class="clip-info" onclick="editor.open(${i})">
                            <div class="clip-title">${clip.title}</div>
                            <div class="mini-timeline"><div class="mini-range" style="left:${p}%;width:${w}%"></div></div>
                        </div>
                        <button onclick="editor.open(${i})" class="bg-gray-800 rounded-full w-8 h-8 flex items-center justify-center">âœ</button>
                    `;
                    c.appendChild(el);
                });
            }

            renderSources() {
                const c = document.getElementById('sources-container'); c.innerHTML = '';
                const filtered = VIDEO_DATABASE.filter(v => !this.searchQuery || (v.title+v.brand+v.objects.join()).toLowerCase().includes(this.searchQuery));
                filtered.forEach(d => {
                    const cnt = this.playlist.filter(p=>p.videoId===d.id).length;
                    const el = document.createElement('div'); el.className = 'source-group';
                    el.innerHTML = `
                        <div class="source-header">
                            <div><div class="source-title">${d.title}</div><div class="text-xs text-gray-500">${d.brand}</div></div>
                            <button onclick="app.addClip('${d.id}')" class="bg-blue-900 px-2 py-1 rounded text-xs text-blue-200">+ ×”×•×¡×£</button>
                        </div>
                        <div class="bg-black/20 p-2 text-xs text-gray-500">${cnt} ×§×˜×¢×™× ×‘××™×§×¡</div>
                    `;
                    c.appendChild(el);
                });
            }

            renderDetails() {
                const clip = this.playlist[this.currentIndex];
                if(!clip) return;
                const data = VIDEO_DATABASE.find(v=>v.id===clip.videoId);
                const c = document.getElementById('details-content');
                let hHtml = '';
                if(data.highlights) data.highlights.forEach(h => hHtml += `<div class="highlight-item" onclick="app.jump(${h.start})"><span class="text-green-400 font-mono bg-gray-800 px-1 rounded">${app.formatTime(h.start)}</span> <span>${h.desc}</span></div>`);
                
                c.innerHTML = `
                    <h2 class="text-xl font-bold">${data.title}</h2>
                    <div class="text-gray-400 text-sm mb-4">${data.concept}</div>
                    <div class="mb-4">
                        ${data.objects.map(o=>`<span class="tag">${o}</span>`).join('')}
                    </div>
                    <div class="bg-gray-900 rounded border border-white/10 overflow-hidden">${hHtml}</div>
                `;
            }

            addClip(vidId) {
                const d = VIDEO_DATABASE.find(v=>v.id===vidId);
                this.playlist.push({uuid:crypto.randomUUID(), videoId:vidId, title:d.title, brand:d.brand, start:0, duration:5, totalDuration:d.duration});
                this.save(); alert('× ×•×¡×£');
            }
            regeneratePlaylist() { if(confirm('×œ×¢×¨×‘×‘?')) { this.playlist = this.createAutoPlaylist(); this.currentIndex=0; this.save(); this.renderUI(); } }
            jump(t) { if(this.activePlayer===1) player1.seekTo(t); else player2.seekTo(t); }
            formatTime(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0'+sc:sc}`; }
            unmuteAll() {
                player1.unMute(); player2.unMute();
                document.getElementById('unmute-overlay').classList.add('hidden');
            }
        }

        class Editor {
            constructor() { this.isOpen = false; this.clip = null; }
            open(idx) {
                this.isOpen = true; this.clip = app.playlist[idx];
                document.getElementById('editor-modal').classList.add('open');
                if(player1) player1.pauseVideo(); if(player2) player2.pauseVideo();
                editorPlayer.loadVideoById({videoId:this.clip.videoId, startSeconds:this.clip.start});
                this.updateUI(); this.startMon();
            }
            close() {
                this.isOpen = false; clearInterval(this.monInt);
                document.getElementById('editor-modal').classList.remove('open');
                editorPlayer.pauseVideo();
                app.save(); app.playSequence(app.currentIndex);
            }
            updateUI() {
                const tot = this.clip.totalDuration||100;
                document.getElementById('label-in').innerText = 'IN: '+this.clip.start.toFixed(1);
                document.getElementById('label-out').innerText = 'OUT: '+(this.clip.start+this.clip.duration).toFixed(1);
                const sP=(this.clip.start/tot)*100, eP=((this.clip.start+this.clip.duration)/tot)*100;
                document.getElementById('handle-in').style.left=sP+'%'; document.getElementById('handle-out').style.left=eP+'%';
                document.getElementById('timeline-fill').style.left=sP+'%'; document.getElementById('timeline-fill').style.width=(eP-sP)+'%';
            }
            startMon() {
                clearInterval(this.monInt);
                this.monInt = setInterval(() => {
                    if(!this.isOpen) return;
                    const t = editorPlayer.getCurrentTime(); if(!t) return;
                    const tot = this.clip.totalDuration||100;
                    document.getElementById('editor-playhead').style.left=(t/tot)*100+'%';
                    document.getElementById('editor-time-display').innerText=app.formatTime(t);
                    if(t > this.clip.start+this.clip.duration) editorPlayer.seekTo(this.clip.start);
                }, 100);
            }
            setupDrag() {
                const trk=document.getElementById('timeline-track-area');
                const move=(e)=>{
                    if(!this.drag) return;
                    const x = e.touches?e.touches[0].clientX:e.clientX;
                    const rect=trk.getBoundingClientRect();
                    let p=(x-rect.left)/rect.width; if(p<0)p=0; if(p>1)p=1;
                    const t=p*(this.clip.totalDuration||100);
                    const MAX_DUR = 15;
                    if(this.drag==='in') {
                         const currentEnd = this.clip.start + this.clip.duration;
                         if (t < currentEnd - 0.5) {
                             let newDur = currentEnd - t;
                             if(newDur <= MAX_DUR) {
                                 this.clip.start = t;
                                 this.clip.duration = newDur;
                             }
                         }
                    } else if(this.drag==='out') {
                        if (t > this.clip.start + 0.5) {
                            let newDur = t - this.clip.start;
                            if(newDur > MAX_DUR) newDur = MAX_DUR;
                            this.clip.duration = newDur;
                        }
                    }
                    this.updateUI();
                };
                ['mousedown','touchstart'].forEach(e=>document.getElementById('handle-in').addEventListener(e,(ev)=>{ev.preventDefault();this.drag='in'}));
                ['mousedown','touchstart'].forEach(e=>document.getElementById('handle-out').addEventListener(e,(ev)=>{ev.preventDefault();this.drag='out'}));
                ['mousemove','touchmove'].forEach(e=>window.addEventListener(e,move,{passive:false}));
                ['mouseup','touchend'].forEach(e=>window.addEventListener(e,()=>{this.drag=null}));
            }
            togglePlay() { editorPlayer.getPlayerState()===1 ? editorPlayer.pauseVideo() : editorPlayer.playVideo(); }
            duplicateClip() { 
                const cp = JSON.parse(JSON.stringify(this.clip)); cp.uuid=crypto.randomUUID(); cp.title+=' (copy)';
                app.playlist.splice(app.playlist.indexOf(this.clip)+1, 0, cp); app.save(); this.close();
            }
            deleteClip() { if(confirm('Delete?')) { app.playlist.splice(app.playlist.indexOf(this.clip), 1); this.close(); } }
        }

        const app = new LoopApp();
        const editor = new Editor();
        let player1, player2, editorPlayer;
        
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);

        function onYouTubeIframeAPIReady() {
            const vars = { controls:0, showinfo:0, rel:0, modestbranding:1, playsinline:1, disablekb:1 };
            const onState = (e) => { 
                // Global watcher? Not needed, handled in interval
            };
            player1 = new YT.Player('player1', { height:'100%', width:'100%', playerVars:vars, events:{'onReady':onR}});
            player2 = new YT.Player('player2', { height:'100%', width:'100%', playerVars:vars, events:{'onReady':onR}});
            editorPlayer = new YT.Player('editor-player', { height:'100%', width:'100%', playerVars:vars, events:{'onReady':e=>{editor.init(e.target)}}});
        }
        
        let rCnt=0;
        function onR(e) { 
            e.target.mute(); 
            rCnt++; 
            if(rCnt===2) {
                app.autoStart();
                document.getElementById('unmute-overlay').classList.remove('hidden');
            }
        }
        editor.init = (p) => { editor.player=p; editor.setupDrag(); }

    </script>
</body>
</html>


